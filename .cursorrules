# tugical (ツギカル) Development Rules
# LINE連携型予約管理SaaS

## Project Overview
- Service: tugical - LINE-connected booking management SaaS
- Concept: "次の時間が、もっと自由になる。" - Time-based resource booking system
- Target: Beauty salons, clinics, rental spaces, schools, activities
- Tech Stack: Laravel + React + Vite + LINE API + MariaDB + Docker
- Repository: https://github.com/tugilo/tugical
- Hosting Strategy: VPS統一運用 → 段階的クラウド移行

## Project Structure
```
tugical/                          ← Git root (/User/tugi/docker/tugical/)
├── .cursorrules                  ← This file
├── .env.example                  ← Environment template
├── .gitignore                    ← Git ignore rules
├── docker-compose.yml            ← Development environment
├── docker-compose.prod.yml       ← Production environment
├── docker/                       ← Docker configurations
│   ├── php/
│   │   ├── Dockerfile           ← PHP 8.2+ with extensions
│   │   └── php.ini              ← PHP configuration
│   ├── nginx/
│   │   └── sites/               ← Multi-environment routing
│   │       ├── tugical.conf     ← Production
│   │       ├── staging.conf     ← Staging
│   │       └── development.conf ← Development
│   ├── mysql/
│   │   ├── init/
│   │   │   └── 01-create-databases.sql ← Multi-env DB setup
│   │   └── my.cnf               ← MariaDB optimization
│   └── redis/
│       └── redis.conf           ← Redis configuration
├── scripts/                      ← Operational scripts
│   ├── deploy.sh                ← Deployment automation
│   ├── backup.sh                ← Database backup
│   ├── health-check.sh          ← System monitoring
│   └── migration-readiness-check.sh ← Cloud migration assessment
├── Makefile                      ← Development commands
├── README.md                     ← Project documentation
├── .github/
│   ├── workflows/
│   │   ├── ci.yml               ← Continuous Integration
│   │   ├── deploy.yml           ← VPS deployment
│   │   ├── security.yml         ← Security analysis
│   │   └── test.yml             ← Test suite execution
│   └── ISSUE_TEMPLATE/          ← Issue templates
│
├── backend/                      ← Laravel API
│   ├── public/                   ← Document root for Nginx
│   ├── app/
│   │   ├── Http/Controllers/    ← API controllers
│   │   │   ├── Api/             ← Admin API controllers
│   │   │   └── Liff/            ← LIFF API controllers
│   │   ├── Models/              ← Eloquent models (follow tugical_database_design_v1.0.md)
│   │   │   ├── Tenant.php       ← Multi-tenant base
│   │   │   ├── Store.php        ← Store model
│   │   │   ├── Booking.php      ← Core booking model
│   │   │   ├── Customer.php     ← Customer model
│   │   │   ├── Resource.php     ← Unified resource model (staff/room/equipment)
│   │   │   └── Menu.php         ← Service menu model
│   │   ├── Services/            ← Business logic
│   │   │   ├── BookingService.php         ← Core booking logic
│   │   │   ├── AvailabilityService.php    ← Time slot management
│   │   │   ├── HoldTokenService.php       ← 10-minute hold system
│   │   │   ├── NotificationService.php    ← LINE notifications
│   │   │   └── IndustryTemplateService.php ← Business templates
│   │   ├── Repositories/        ← Data access layer
│   │   ├── Middleware/          ← Custom middleware
│   │   │   ├── TenantScope.php  ← Multi-tenant isolation
│   │   │   └── RateLimit.php    ← Plan-based rate limiting
│   │   ├── Exceptions/          ← Custom exceptions
│   │   │   ├── BookingConflictException.php
│   │   │   ├── OutsideBusinessHoursException.php
│   │   │   └── HoldTokenExpiredException.php
│   │   └── Jobs/                ← Queue jobs
│   │       ├── SendLineNotification.php
│   │       └── ProcessBookingReminder.php
│   ├── config/
│   ├── database/
│   │   ├── migrations/          ← DB schema (exact match tugical_database_design_v1.0.md)
│   │   ├── seeders/             ← Demo data + industry templates
│   │   └── factories/           ← Model factories for testing
│   ├── routes/
│   │   ├── api.php              ← Admin API routes
│   │   ├── liff.php             ← LIFF API routes
│   │   └── web.php              ← Health check routes
│   ├── tests/
│   │   ├── Unit/                ← Unit tests (80%+ coverage target)
│   │   ├── Feature/             ← Integration tests
│   │   └── Performance/         ← Load testing scripts
│   ├── composer.json
│   └── artisan
│
├── frontend/                     ← Admin dashboard (React + Vite)
│   ├── src/
│   │   ├── components/          ← Reusable UI components
│   │   │   ├── ui/              ← Basic UI components (Button, Input, Card)
│   │   │   ├── booking/         ← Booking-specific components
│   │   │   │   ├── BookingCard.tsx
│   │   │   │   ├── CalendarView.tsx
│   │   │   │   └── BookingForm.tsx
│   │   │   ├── customer/        ← Customer management
│   │   │   ├── resource/        ← Resource management
│   │   │   └── layout/          ← Layout components
│   │   ├── pages/               ← Page components
│   │   │   ├── dashboard/       ← Dashboard views
│   │   │   ├── bookings/        ← Booking management
│   │   │   ├── customers/       ← Customer management
│   │   │   ├── resources/       ← Staff/resource management
│   │   │   ├── menus/           ← Menu management
│   │   │   └── settings/        ← Store settings
│   │   ├── hooks/               ← Custom hooks
│   │   │   ├── useBookingForm.ts
│   │   │   ├── useAvailability.ts
│   │   │   └── useRealTimeUpdates.ts
│   │   ├── services/            ← API services
│   │   │   ├── api.ts           ← Base API client
│   │   │   ├── bookingApi.ts    ← Booking API calls
│   │   │   └── customerApi.ts   ← Customer API calls
│   │   ├── stores/              ← State management (Zustand/Redux)
│   │   ├── utils/               ← Utility functions
│   │   └── types/               ← TypeScript type definitions
│   ├── public/
│   ├── package.json
│   ├── vite.config.js
│   └── tailwind.config.js       ← Tugical design system
│
├── liff/                        ← Customer LIFF app (React + Vite)
│   ├── src/
│   │   ├── components/          ← LIFF-specific components
│   │   │   ├── booking/         ← Booking flow components
│   │   │   │   ├── MenuSelection.tsx     ← Step 1: Menu selection
│   │   │   │   ├── ResourceSelection.tsx ← Step 2: Staff/resource selection
│   │   │   │   ├── TimeSelection.tsx     ← Step 3: Date/time selection
│   │   │   │   ├── CustomerInfo.tsx      ← Step 4: Customer information
│   │   │   │   └── BookingConfirm.tsx    ← Step 5: Confirmation
│   │   │   ├── ui/              ← LIFF UI components
│   │   │   └── layout/          ← LIFF layout
│   │   ├── pages/               ← Booking flow pages
│   │   │   ├── BookingFlow.tsx  ← Main booking flow
│   │   │   ├── BookingHistory.tsx ← User booking history
│   │   │   └── BookingSuccess.tsx ← Success page
│   │   ├── hooks/               ← LIFF hooks
│   │   │   ├── useLiff.ts       ← LINE LIFF SDK integration
│   │   │   ├── useBookingFlow.ts ← Booking flow state
│   │   │   └── useHoldToken.ts  ← Hold token management
│   │   ├── services/            ← LIFF API services
│   │   │   ├── liffApi.ts       ← LIFF-specific API calls
│   │   │   └── lineAuth.ts      ← LINE authentication
│   │   └── utils/               ← LIFF utilities
│   ├── public/
│   ├── package.json
│   └── vite.config.js
│
└── docs/                        ← Documentation
    ├── tugical_project_overview.md          ← Project overview
    ├── tugical_requirements_specification_v1.0.md ← Requirements spec
    ├── tugical_database_design_v1.0.md      ← Database design (MUST FOLLOW)
    ├── tugical_api_specification_v1.0.md    ← API specification
    ├── tugical_deployment_guide_v1.0.md     ← VPS deployment guide
    ├── tugical_test_strategy_v1.0.md        ← Testing strategy
    ├── tugical_ui_design_system_v1.0.md     ← UI/UX design system
    ├── PROGRESS.md                           ← Current development status
    ├── DEVELOPMENT_LOG.md                    ← Daily progress log
    └── CURRENT_FOCUS.md                      ← Detailed current task
```
## FIRST SETUP INSTRUCTIONS (初回セットアップ必須手順)

### Phase 0: Environment & Git Setup (最優先)
1. **Docker Environment Creation**
   - Create all docker configuration files
   - Verify all containers start successfully
   - Test database connections and health checks

2. **Git Repository Initialization**
   - Initialize Git repository
   - Create develop branch for active development
   - Push initial Docker environment to remote repository
   - Establish branch protection and CI/CD triggers

3. **Development Workflow Establishment**
   - Verify make commands work correctly
   - Document environment status in docs/ENVIRONMENT_STATUS.md
   - Create initial progress documentation

### Critical Success Criteria for Phase 0:
- [ ] All Docker containers running healthy
- [ ] Database connections verified (dev/staging/prod)
- [ ] Redis connectivity confirmed
- [ ] Nginx routing working for all environments
- [ ] Health check endpoints responding
- [ ] Git repository created with develop branch
- [ ] Initial codebase pushed to remote repository
- [ ] Makefile commands functional

**⚠️ DO NOT PROCEED TO LARAVEL SETUP UNTIL PHASE 0 IS COMPLETE**

## Architecture Rules

### Multi-Tenant Design (CRITICAL)
- Use single database with store_id isolation for all tables
- ALL models must include store_id for tenant separation
- Implement TenantScope middleware for automatic store_id filtering
- NEVER allow cross-tenant data access - security violation
- Use Laravel's global scopes for automatic store_id filtering
- Follow tugical_database_design_v1.0.md schema EXACTLY

### Database Rules (Follow tugical_database_design_v1.0.md)
- Use snake_case for table and column names
- Implement proper foreign key constraints with CASCADE/SET NULL
- Use JSON columns for flexible settings (business_hours, attributes, notification_settings)
- Add proper indexes for performance (especially store_id combinations)
- Use Laravel migrations for all schema changes
- Multi-environment database setup: tugical_dev, tugical_staging, tugical_prod

### Backend (Laravel) Rules
- Use Laravel 10+ with PHP 8.2+
- Follow PSR-12 coding standards
- Implement API resources for consistent JSON responses (follow tugical_api_specification_v1.0.md)
- Use Form Requests for validation with custom error messages
- Implement proper error handling with structured JSON responses
- Use Laravel Sanctum for staff authentication
- Implement rate limiting based on plan (100-1000 req/min per tugical_requirements_specification_v1.0.md)
- Use Laravel's built-in features (Queue, Cache, Events)
- Implement proper logging for all business actions

### Frontend (React + Vite) Rules
- Use TypeScript for all components and services
- Follow React functional components with hooks pattern
- Use Tailwind CSS core utility classes only (follow tugical_ui_design_system_v1.0.md)
- Implement Framer Motion for smooth animations
- Use proper error boundaries and loading states
- Implement optimistic updates for better UX
- Mobile-first responsive design
- Use React Query/SWR for data fetching and caching

### LIFF App Rules
- Use React with Vite for fast development
- Implement LINE LIFF SDK properly
- Handle LINE user authentication with UUID
- Implement hold token system for booking conflicts (10-minute expiry)
- Support both auto-approval and manual approval modes
- Implement 5-step booking flow with progress saving
- **CRITICAL**: localStorage has limited support in LIFF environment - use React state and sessionStorage sparingly
- Follow booking flow: Menu → Resource → DateTime → CustomerInfo → Confirmation

### LINE Integration Rules
- Use LINE Messaging API v2 and LIFF v2
- Implement proper webhook handling for messages
- Handle LINE user authentication and profile access
- Implement message templates with variable substitution
- Handle delivery status and implement retry logic
- Support rich messages and quick replies
- Implement proper error handling for LINE API failures

### Docker Rules (VPS統一運用)

#### Complete Docker Environment Setup
```yaml
# docker-compose.yml (Development)
version: '3.8'
services:
  app:
    build: 
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: tugical_app
    volumes:
      - ./backend:/var/www/html
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini
    environment:
      - APP_ENV=local
      - CONTAINER_ROLE=app
    depends_on:
      - database
      - redis
    networks:
      - tugical-network

  nginx:
    image: nginx:1.24-alpine
    container_name: tugical_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/sites:/etc/nginx/sites-available
      - ./backend/public:/var/www/html/backend/public
      - ./frontend/dist:/var/www/html/frontend
      - ./liff/dist:/var/www/html/liff
      - ./docker/ssl:/etc/nginx/ssl
    depends_on:
      - app
    networks:
      - tugical-network

  database:
    image: mariadb:10.11
    container_name: tugical_db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_USER: tugical
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - tugical-network

  redis:
    image: redis:7.2-alpine
    container_name: tugical_redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - "6379:6379"
    networks:
      - tugical-network

  queue:
    build: 
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: tugical_queue
    volumes:
      - ./backend:/var/www/html
    environment:
      - APP_ENV=local
      - CONTAINER_ROLE=queue
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    depends_on:
      - database
      - redis
    networks:
      - tugical-network

  scheduler:
    build: 
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: tugical_scheduler
    volumes:
      - ./backend:/var/www/html
    environment:
      - APP_ENV=local
      - CONTAINER_ROLE=scheduler
    command: supercronic /var/www/html/docker/cron/crontab
    depends_on:
      - database
      - redis
    networks:
      - tugical-network

  frontend:
    image: node:18-alpine
    container_name: tugical_frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: npm run dev
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
    networks:
      - tugical-network

  liff:
    image: node:18-alpine
    container_name: tugical_liff
    working_dir: /app
    volumes:
      - ./liff:/app
    command: npm run dev
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
    networks:
      - tugical-network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local

networks:
  tugical-network:
    driver: bridge
```

#### Required Docker Files Structure
```
docker/
├── php/
│   ├── Dockerfile              ← PHP 8.2 with all extensions
│   ├── php.ini                 ← PHP configuration
│   └── entrypoint.sh           ← Container startup script
├── nginx/
│   ├── nginx.conf              ← Main Nginx config
│   └── sites/
│       ├── development.conf    ← Dev environment
│       ├── staging.conf        ← Staging environment
│       └── production.conf     ← Production environment
├── mysql/
│   ├── init/
│   │   └── 01-create-databases.sql ← Multi-env DB setup
│   └── my.cnf                  ← MariaDB optimization
├── redis/
│   └── redis.conf              ← Redis configuration
└── ssl/                        ← SSL certificates
    ├── development/
    ├── staging/
    └── production/
```

#### PHP Dockerfile Requirements
```dockerfile
# docker/php/Dockerfile
FROM php:8.2-fpm-alpine

# Install system dependencies
RUN apk add --no-cache \
    curl \
    libpng-dev \
    libxml2-dev \
    zip \
    unzip \
    git \
    oniguruma-dev \
    icu-dev \
    autoconf \
    g++ \
    make

# Install PHP extensions
RUN docker-php-ext-configure intl \
    && docker-php-ext-install \
        pdo_mysql \
        mbstring \
        exif \
        pcntl \
        bcmath \
        gd \
        intl

# Install Redis extension
RUN pecl install redis && docker-php-ext-enable redis

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Install supercronic for cron jobs
RUN curl -fsSLO "https://github.com/aptible/supercronic/releases/download/v0.2.24/supercronic-linux-amd64" \
    && chmod +x supercronic-linux-amd64 \
    && mv supercronic-linux-amd64 /usr/local/bin/supercronic

# Set working directory
WORKDIR /var/www/html

# Set permissions
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

# Copy entrypoint
COPY entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["php-fpm"]
```

#### Environment-Specific Nginx Configuration

##### Development Environment
```nginx
# docker/nginx/sites/development.conf
server {
    listen 80;
    server_name dev.tugical.com localhost;
    root /var/www/html/backend/public;
    index index.php;

    # API routes
    location /api/ {
        try_files $uri $uri/ /index.php?$query_string;
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param APP_ENV local;
        include fastcgi_params;
    }

    # Admin panel (React dev server)
    location /admin/ {
        proxy_pass http://frontend:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # WebSocket support for Vite HMR
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # LIFF app (Vite dev server)
    location /liff/ {
        proxy_pass http://liff:5173/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # WebSocket support for Vite HMR
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # PHP file handling
    location ~ \.php$ {
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Health check
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

##### Staging Environment
```nginx
# docker/nginx/sites/staging.conf
server {
    listen 80;
    listen 443 ssl http2;
    server_name staging.tugical.com;
    root /var/www/html/backend/public;
    index index.php;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/staging.tugical.com.crt;
    ssl_certificate_key /etc/nginx/ssl/staging.tugical.com.key;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;

    # API routes
    location /api/ {
        try_files $uri $uri/ /index.php?$query_string;
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param APP_ENV staging;
        include fastcgi_params;
    }

    # Admin panel (built files)
    location /admin/ {
        alias /var/www/html/frontend/;
        try_files $uri $uri/ /admin/index.html;
    }

    # LIFF application (built files)
    location /liff/ {
        alias /var/www/html/liff/;
        try_files $uri $uri/ /liff/index.html;
    }

    # PHP file handling
    location ~ \.php$ {
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param APP_ENV staging;
        include fastcgi_params;
    }
}
```

##### Production Environment
```nginx
# docker/nginx/sites/production.conf
server {
    listen 80;
    server_name tugical.com www.tugical.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name tugical.com www.tugical.com;
    root /var/www/html/backend/public;
    index index.php;

    # SSL Configuration (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/tugical.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tugical.com/privkey.pem;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' static.line-scdn.net; style-src 'self' 'unsafe-inline'" always;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=global:10m rate=50r/s;

    # API routes with rate limiting
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        limit_req zone=global burst=100 nodelay;
        
        try_files $uri $uri/ /index.php?$query_string;
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param APP_ENV production;
        include fastcgi_params;
    }

    # Admin panel with basic auth
    location /admin/ {
        alias /var/www/html/frontend/;
        try_files $uri $uri/ /admin/index.html;
        
        # Basic auth for extra security
        auth_basic "tugical Admin";
        auth_basic_user_file /etc/nginx/.htpasswd;
    }

    # LIFF application
    location /liff/ {
        alias /var/www/html/liff/;
        try_files $uri $uri/ /liff/index.html;
    }

    # PHP file handling
    location ~ \.php$ {
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param APP_ENV production;
        include fastcgi_params;
    }

    # Static files caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Health check endpoint
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

#### Multi-Environment Database Setup
```sql
-- docker/mysql/init/01-create-databases.sql
CREATE DATABASE IF NOT EXISTS tugical_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS tugical_staging CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS tugical_prod CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Development user
CREATE USER IF NOT EXISTS 'tugical_dev'@'%' IDENTIFIED BY 'dev_password_123';
GRANT ALL PRIVILEGES ON tugical_dev.* TO 'tugical_dev'@'%';

-- Staging user
CREATE USER IF NOT EXISTS 'tugical_staging'@'%' IDENTIFIED BY 'staging_password_456';
GRANT ALL PRIVILEGES ON tugical_staging.* TO 'tugical_staging'@'%';

-- Production user (limited permissions)
CREATE USER IF NOT EXISTS 'tugical_prod'@'%' IDENTIFIED BY 'prod_password_789';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON tugical_prod.* TO 'tugical_prod'@'%';

FLUSH PRIVILEGES;
```

#### Development Makefile
```makefile
# Makefile
.PHONY: help build up down restart logs shell test

help: ## Show this help message
	@echo 'usage: make [target]'
	@echo ''
	@echo 'targets:'
	@egrep '^(.+)\:\ ##\ (.+)' $(MAKEFILE_LIST) | column -t -c 2 -s ':#'

build: ## Build Docker containers
	docker-compose build

up: ## Start all services
	docker-compose up -d
	@echo "Services starting..."
	@echo "Frontend: http://localhost:3000"
	@echo "LIFF: http://localhost:5173"
	@echo "API: http://localhost/api/v1/health"

down: ## Stop all services
	docker-compose down

restart: ## Restart all services
	docker-compose restart

logs: ## Show logs
	docker-compose logs -f

shell: ## Access app container shell
	docker-compose exec app sh

test: ## Run tests
	docker-compose exec app php artisan test
	docker-compose exec frontend npm test
	docker-compose exec liff npm test

install: ## Install dependencies
	docker-compose exec app composer install
	docker-compose exec frontend npm install
	docker-compose exec liff npm install

migrate: ## Run database migrations
	docker-compose exec app php artisan migrate

seed: ## Run database seeders
	docker-compose exec app php artisan db:seed

fresh: ## Fresh installation
	docker-compose exec app php artisan migrate:fresh --seed

status: ## Show container status
	docker-compose ps

health: ## Check health status
	@echo "Checking API health..."
	@curl -f http://localhost/health || echo "API not responding"
	@echo "Checking database..."
	@docker-compose exec database mysql -u tugical_dev -pdev_password_123 -e "SELECT 1" tugical_dev > /dev/null && echo "Database OK" || echo "Database error"
	@echo "Checking Redis..."
	@docker-compose exec redis redis-cli ping || echo "Redis error"
```

#### Environment Variables Template
```bash
# .env.example
# Application
APP_NAME="tugical"
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost

# Database
DB_CONNECTION=mysql
DB_HOST=database
DB_PORT=3306
DB_DATABASE=tugical_dev
DB_USERNAME=tugical_dev
DB_PASSWORD=dev_password_123
DB_ROOT_PASSWORD=root_password_123

# Redis
REDIS_HOST=redis
REDIS_PASSWORD=redis_password_123
REDIS_PORT=6379
REDIS_DB=0

# LINE API
LINE_CHANNEL_ID=
LINE_CHANNEL_SECRET=
LINE_ACCESS_TOKEN=

# Cache
CACHE_DRIVER=redis
CACHE_PREFIX=tugical_dev

# Queue
QUEUE_CONNECTION=redis
QUEUE_PREFIX=tugical_dev

# Session
SESSION_DRIVER=redis
SESSION_LIFETIME=120

# Mail
MAIL_MAILER=log
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="hello@tugical.com"
MAIL_FROM_NAME="${APP_NAME}"
```

#### Quick Setup Commands
```bash
# Initial setup
make build
make up
make install
make migrate
make seed

# Daily development
make up
make logs  # Monitor logs
make shell # Access container
make test  # Run tests

# Troubleshooting
make health
make status
make restart
```

#### Container Health Checks
- PHP-FPM health monitoring
- Database connection verification
- Redis connectivity checks
- Nginx proxy status
- Hot reload functionality for development
- Multi-environment configuration switching

### Security Rules
- Encrypt sensitive data (bcrypt for passwords, AES-256 for API keys)
- Implement proper CORS settings for different origins
- Use HTTPS for all communications (force in production)
- Implement proper input validation and sanitization
- Log all security events and failed attempts
- Implement rate limiting and DDoS protection
- Use environment variables for all sensitive configuration
- Implement proper session management

## Business Logic Implementation (Core Features)

### Unified Resource Concept (tugical_requirements_specification_v1.0.md)
```
Resource Types:
- staff (美容師、施術者、講師、ガイド)
- room (個室、教室、会議室)
- equipment (設備、器具、車両)
- vehicle (送迎車、レンタカー)

Key Properties:
- type, name, display_name (業種別表示)
- attributes (JSON: specialties, skill_level, etc.)
- working_hours (JSON: 曜日別稼働時間)
- efficiency_rate (0.8-1.2: 作業効率率)
- hourly_rate_diff (指名料金差)
```

### Booking System Core Logic
```php
// Booking equation: 予約 = リソース × 時間枠 × メニュー
// Total duration = base_duration + prep_duration + cleanup_duration
// Adjusted duration = total_duration * resource.efficiency_rate
// Total price = base_price + option_prices + resource.hourly_rate_diff
```

### Hold Token System (仮押さえ)
- 10-minute reservation hold to prevent conflicts
- Cryptographically secure tokens
- Automatic cleanup of expired holds
- Real-time availability updates

### Industry Templates (業種テンプレート)
```yaml
Supported Industries:
  Beauty/Nail: 指名制・技能差・性別制限
  Clinic/Therapy: 繰り返し予約・スタッフ割当
  Rental Space: 部屋別予約・設備選択・収容人数
  School/Class: 親の代理予約・曜日固定制・定期予約
  Activity/Guide: プライバシー配慮・事前入力・定員制
```

### Approval Modes
- **Auto-approval**: Instant confirmation
- **Manual approval**: Up to 3 preferred times, staff confirmation required

## UI Implementation Rules (tugical_ui_design_system_v1.0.md準拠)

### Reference Mock Screens (MUST USE FOR IMPLEMENTATION)

#### Admin Dashboard Screens
| Screen | URL | Implementation Focus |
|--------|-----|----------------------|
| Dashboard | https://claude.ai/public/artifacts/8ac4aa2e-a426-4917-8a13-1609b4f71ada | Today's bookings, sales summary, notification list |
| Booking Management | https://claude.ai/public/artifacts/34e6d2d3-c69b-4ed8-badb-b9a3a62dbcc1 | Booking list, filters, search functionality |
| Booking Approval | https://claude.ai/public/artifacts/22e1cddc-d67a-44ac-8e66-732d94322282 | Manual approval mode, up to 3 preferences |
| Customer Management | https://claude.ai/public/artifacts/85aaf66c-2f71-4d38-9cf8-5dba7ca269c9 | Customer list, details, loyalty rank management |
| Staff Management | https://claude.ai/public/artifacts/dd4cda4c-c19f-495c-ace1-670a2dc7f6eb | Resource management, working hours settings |
| Menu Management | https://claude.ai/public/artifacts/a401a015-aa53-484c-b095-b43a7942132f | Menu/option configuration |
| Settings | https://claude.ai/public/artifacts/85aaf66c-2f71-4d38-9cf8-5dba7ca269c9 | Business hours, notifications, industry settings |

#### LIFF Customer Screens
| Screen | URL | Implementation Focus |
|--------|-----|----------------------|
| Menu Selection | https://claude.ai/public/artifacts/ba499c4e-7edd-45b9-83ae-ab5f061eb018 | Card layout, detail modals |
| Date/Time Selection | https://claude.ai/public/artifacts/849ea506-151a-4ba9-8cf3-4027444aa906 | Calendar, hold token display |
| Booking Success | https://claude.ai/public/artifacts/56784c27-3fe7-45eb-a0c3-b60081e28600 | Booking number, LINE notification integration |
| Booking History | https://claude.ai/public/artifacts/8065eebd-9e4d-425f-9f89-ae04cc7ebd57 | Past bookings, status display |

### Design System Implementation

#### Tailwind Configuration (EXACT COPY)
```javascript
// tailwind.config.js
module.exports = {
  content: [
    "./src/**/*.{js,ts,jsx,tsx}",
    "./index.html"
  ],
  theme: {
    extend: {
      colors: {
        // tugical Brand Colors
        primary: {
          50: '#f0fdfa',   // 背景用薄いミント
          100: '#ccfbf1',  // ホバー状態
          500: '#10b981',  // メインカラー（ミントグリーン）
          600: '#059669',  // アクティブ状態
          900: '#064e3b',  // 濃いアクセント
        },
        // Status Colors for Booking
        booking: {
          pending: '#f59e0b',     // 申込み中
          confirmed: '#10b981',   // 確定
          cancelled: '#ef4444',   // キャンセル
          completed: '#6b7280',   // 完了
          noshow: '#dc2626',      // 無断キャンセル
        }
      },
      fontFamily: {
        sans: ['Nunito', 'Noto Sans JP', 'system-ui', 'sans-serif'],
        mono: ['JetBrains Mono', 'Courier New', 'monospace'],
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-out',
        'slide-up': 'slideUp 0.4s ease-out',
        'scale-in': 'scaleIn 0.2s ease-out',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0', transform: 'translateY(20px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        slideUp: {
          '0%': { opacity: '0', transform: 'translateY(50px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        scaleIn: {
          '0%': { opacity: '0', transform: 'scale(0.9)' },
          '100%': { opacity: '1', transform: 'scale(1)' },
        },
      },
    },
  },
  plugins: [],
}
```

#### Core Component Implementation Standards

##### Button Component (EXACT IMPLEMENTATION)
```typescript
// src/components/ui/Button/Button.tsx
import React from 'react';
import { motion } from 'framer-motion';
import { cn } from '../../../utils/cn';

interface ButtonProps {
  variant: 'primary' | 'secondary' | 'outline' | 'ghost' | 'danger';
  size: 'xs' | 'sm' | 'md' | 'lg' | 'xl';
  disabled?: boolean;
  loading?: boolean;
  fullWidth?: boolean;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
  onClick?: () => void;
  children: React.ReactNode;
  type?: 'button' | 'submit' | 'reset';
  className?: string;
}

/**
 * tugicalの基本ボタンコンポーネント
 * 全ての画面で統一されたボタンスタイルを提供
 */
const Button: React.FC<ButtonProps> = ({
  variant = 'primary',
  size = 'md',
  disabled = false,
  loading = false,
  fullWidth = false,
  leftIcon,
  rightIcon,
  onClick,
  children,
  type = 'button',
  className,
}) => {
  const baseClasses = cn(
    'inline-flex items-center justify-center font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed',
    {
      // Variant styles
      'bg-primary-500 text-white hover:bg-primary-600 focus:ring-primary-500': variant === 'primary',
      'bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500': variant === 'secondary',
      'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-primary-500': variant === 'outline',
      'text-gray-700 hover:bg-gray-100 focus:ring-gray-500': variant === 'ghost',
      'bg-red-500 text-white hover:bg-red-600 focus:ring-red-500': variant === 'danger',
      
      // Size styles
      'px-2 py-1 text-xs rounded': size === 'xs',
      'px-3 py-1.5 text-sm rounded-md': size === 'sm',
      'px-4 py-2 text-base rounded-md': size === 'md',
      'px-6 py-3 text-lg rounded-lg': size === 'lg',
      'px-8 py-4 text-xl rounded-lg': size === 'xl',
      
      // Full width
      'w-full': fullWidth,
    },
    className
  );

  return (
    <motion.button
      type={type}
      className={baseClasses}
      onClick={onClick}
      disabled={disabled || loading}
      whileTap={{ scale: 0.98 }}
      transition={{ duration: 0.1 }}
    >
      {loading && (
        <svg
          className="w-4 h-4 mr-2 animate-spin"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            className="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            strokeWidth="4"
          />
          <path
            className="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
      )}
      {leftIcon && !loading && <span className="mr-2">{leftIcon}</span>}
      {children}
      {rightIcon && <span className="ml-2">{rightIcon}</span>}
    </motion.button>
  );
};

export default Button;
```

##### BookingCard Component (FROM MOCK SCREENS)
```typescript
// src/components/booking/BookingCard/BookingCard.tsx
import React from 'react';
import { motion } from 'framer-motion';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import { cn } from '../../../utils/cn';
import Button from '../../ui/Button/Button';

interface BookingCardProps {
  booking: {
    id: number;
    booking_number: string;
    booking_date: string;
    start_time: string;
    end_time: string;
    status: 'pending' | 'confirmed' | 'cancelled' | 'completed' | 'no_show';
    customer: {
      name: string;
      phone: string;
    };
    menu: {
      name: string;
      duration: number;
    };
    resource?: {
      name: string;
    };
    total_price: number;
    customer_notes?: string;
  };
  mode: 'compact' | 'detailed';
  onEdit?: (booking: any) => void;
  onCancel?: (booking: any) => void;
  onComplete?: (booking: any) => void;
  className?: string;
}

/**
 * 予約カードコンポーネント
 * 管理画面とダッシュボードで予約情報を表示
 */
const BookingCard: React.FC<BookingCardProps> = ({
  booking,
  mode = 'compact',
  onEdit,
  onCancel,
  onComplete,
  className,
}) => {
  const statusColors = {
    pending: 'bg-yellow-100 text-yellow-800',
    confirmed: 'bg-emerald-100 text-emerald-800',
    cancelled: 'bg-red-100 text-red-800',
    completed: 'bg-gray-100 text-gray-800',
    no_show: 'bg-red-200 text-red-900',
  };

  const statusLabels = {
    pending: '申込み中',
    confirmed: '確定',
    cancelled: 'キャンセル',
    completed: '完了',
    no_show: '無断キャンセル',
  };

  return (
    <motion.div
      className={cn(
        'bg-white rounded-lg p-4 shadow-sm border border-gray-200 hover:shadow-md transition-shadow',
        className
      )}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      whileHover={{ scale: 1.01 }}
      transition={{ duration: 0.2 }}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <span
          className={cn(
            'px-2 py-1 rounded-full text-sm font-medium',
            statusColors[booking.status]
          )}
        >
          {statusLabels[booking.status]}
        </span>
        <span className="text-gray-500 text-sm font-mono">
          {booking.booking_number}
        </span>
      </div>

      {/* Customer Info */}
      <div className="mb-3">
        <h3 className="font-semibold text-gray-900 mb-1">
          {booking.customer.name}
        </h3>
        <p className="text-gray-600 text-sm">{booking.customer.phone}</p>
      </div>

      {/* Booking Details */}
      <div className="mb-3">
        <div className="flex items-center justify-between mb-2">
          <span className="text-gray-700 font-medium">{booking.menu.name}</span>
          <span className="text-primary-600 font-semibold">
            ¥{booking.total_price.toLocaleString()}
          </span>
        </div>
        
        <div className="flex items-center text-sm text-gray-600">
          <span>
            {format(new Date(booking.booking_date), 'M月d日(E)', { locale: ja })}
          </span>
          <span className="mx-2">•</span>
          <span>{booking.start_time} - {booking.end_time}</span>
          {booking.resource && (
            <>
              <span className="mx-2">•</span>
              <span>{booking.resource.name}</span>
            </>
          )}
        </div>
      </div>

      {/* Customer Notes */}
      {mode === 'detailed' && booking.customer_notes && (
        <div className="mb-3 p-2 bg-gray-50 rounded text-sm text-gray-700">
          <span className="font-medium">要望:</span> {booking.customer_notes}
        </div>
      )}

      {/* Actions */}
      {mode === 'detailed' && (onEdit || onCancel || onComplete) && (
        <div className="flex gap-2 pt-3 border-t border-gray-100">
          {onEdit && (
            <Button
              variant="outline"
              size="sm"
              onClick={() => onEdit(booking)}
            >
              編集
            </Button>
          )}
          {onComplete && booking.status === 'confirmed' && (
            <Button
              variant="primary"
              size="sm"
              onClick={() => onComplete(booking)}
            >
              完了
            </Button>
          )}
          {onCancel && ['pending', 'confirmed'].includes(booking.status) && (
            <Button
              variant="danger"
              size="sm"
              onClick={() => onCancel(booking)}
            >
              キャンセル
            </Button>
          )}
        </div>
      )}
    </motion.div>
  );
};

export default BookingCard;
```

##### LIFF Layout Component
```typescript
// src/components/layout/LiffLayout/LiffLayout.tsx
import React from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ArrowLeftIcon } from '@heroicons/react/24/outline';

interface LiffLayoutProps {
  title: string;
  currentStep?: number;
  totalSteps?: number;
  onBack?: () => void;
  showProgress?: boolean;
  children: React.ReactNode;
  bottomAction?: React.ReactNode;
}

/**
 * LIFF画面共通レイアウト
 * ヘッダー、プログレスバー、メインコンテンツ、ボトムアクションを統一
 */
const LiffLayout: React.FC<LiffLayoutProps> = ({
  title,
  currentStep,
  totalSteps,
  onBack,
  showProgress = false,
  children,
  bottomAction,
}) => {
  const progressPercentage = showProgress && currentStep && totalSteps 
    ? (currentStep / totalSteps) * 100 
    : 0;

  return (
    <div className="liff-container min-h-screen bg-gradient-to-b from-primary-50 to-white">
      {/* Header */}
      <header className="bg-white shadow-sm border-b border-gray-200">
        <div className="px-4 py-3 flex items-center justify-between">
          <div className="flex items-center">
            {onBack && (
              <button
                onClick={onBack}
                className="mr-3 p-1 rounded-md hover:bg-gray-100 transition-colors"
              >
                <ArrowLeftIcon className="w-5 h-5 text-gray-600" />
              </button>
            )}
            <h1 className="text-lg font-semibold text-gray-900">{title}</h1>
          </div>
          
          {showProgress && currentStep && totalSteps && (
            <span className="text-sm text-gray-600">
              Step {currentStep}/{totalSteps}
            </span>
          )}
        </div>
        
        {/* Progress Bar */}
        {showProgress && (
          <div className="h-1 bg-gray-200">
            <motion.div
              className="h-full bg-primary-500"
              initial={{ width: 0 }}
              animate={{ width: `${progressPercentage}%` }}
              transition={{ duration: 0.3, ease: 'easeOut' }}
            />
          </div>
        )}
      </header>

      {/* Main Content */}
      <main className="flex-1 px-4 py-6">
        <AnimatePresence mode="wait">
          <motion.div
            key={currentStep || 'content'}
            initial={{ opacity: 0, x: 50 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: -50 }}
            transition={{ duration: 0.3, ease: 'easeInOut' }}
          >
            {children}
          </motion.div>
        </AnimatePresence>
      </main>

      {/* Bottom Action */}
      {bottomAction && (
        <div className="sticky bottom-0 bg-white border-t border-gray-200 p-4 safe-area-pb">
          {bottomAction}
        </div>
      )}
    </div>
  );
};

export default LiffLayout;
```

### Performance Requirements (CRITICAL)
```yaml
Performance Targets:
  LIFF Screen Load: < 2 seconds (measured from liff.init() to interactive)
  Booking Operations: < 3 seconds (from form submit to success feedback)
  Admin Dashboard: < 1 second (initial page load)
  LINE Notifications: < 10 seconds (from trigger to delivery)
  
Optimization Requirements:
  - Lazy load non-critical components
  - Use React.memo for expensive re-renders
  - Implement virtual scrolling for large lists (>100 items)
  - Optimize images (WebP format, responsive sizes)
  - Bundle splitting for admin vs LIFF apps
```

### Mobile-First Implementation (MANDATORY)
```css
/* Mobile-first breakpoint strategy */
/* Base styles: Mobile (320px+) */
.component {
  padding: 1rem;
  font-size: 0.875rem;
}

/* Tablet (768px+) */
@media (min-width: 768px) {
  .component {
    padding: 1.5rem;
    font-size: 1rem;
  }
}

/* Desktop (1024px+) */
@media (min-width: 1024px) {
  .component {
    padding: 2rem;
    font-size: 1rem;
  }
}
```

### Industry Template UI Support
```typescript
// 業種別表示名の実装例
const getIndustryDisplayNames = (industryType: string) => {
  const displayNames = {
    beauty: {
      resource: 'スタッフ',
      customer: 'お客様',
      booking: 'ご予約',
    },
    clinic: {
      resource: '先生',
      customer: '患者様',
      booking: '診療予約',
    },
    rental: {
      resource: '部屋',
      customer: 'ご利用者様',
      booking: '利用予約',
    },
    school: {
      resource: '講師',
      customer: '生徒様',
      booking: '授業予約',
    },
    activity: {
      resource: 'ガイド',
      customer: '参加者様',
      booking: '体験予約',
    },
  };
  
  return displayNames[industryType] || displayNames.beauty;
};
```

### LIFF-Specific Implementation Rules

#### localStorage Limitations (CRITICAL)
```typescript
// ❌ WRONG: localStorage is not fully supported in LIFF
localStorage.setItem('booking_data', JSON.stringify(data));

// ✅ CORRECT: Use React state with sessionStorage as backup
const [bookingData, setBookingData] = useState(() => {
  try {
    const saved = sessionStorage.getItem('booking_draft');
    return saved ? JSON.parse(saved) : {};
  } catch {
    return {};
  }
});

// Save to sessionStorage on updates
useEffect(() => {
  try {
    sessionStorage.setItem('booking_draft', JSON.stringify(bookingData));
  } catch (error) {
    console.warn('Failed to save booking draft:', error);
  }
}, [bookingData]);
```

#### LIFF SDK Integration
```typescript
// LIFF initialization pattern
useEffect(() => {
  const initializeLiff = async () => {
    try {
      await liff.init({ liffId: process.env.REACT_APP_LIFF_ID });
      
      if (liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        setUserProfile(profile);
      } else {
        liff.login();
      }
    } catch (error) {
      console.error('LIFF initialization failed:', error);
      // Fallback for non-LIFF environments (development)
      if (process.env.NODE_ENV === 'development') {
        setUserProfile({
          userId: 'dev_user_123',
          displayName: 'テストユーザー',
          pictureUrl: '',
        });
      }
    }
  };

  initializeLiff();
}, []);
```

## Feature Implementation Priorities

### MVP Features (Phase 1 - MUST implement first)
1. **LIFF Booking Flow**: 5-step booking process with hold token system
2. **Admin Booking Management**: Calendar/list views with drag-and-drop
3. **LINE Notification System**: Template-based notifications with retry
4. **Industry Templates**: 5 basic templates implementation
5. **Real-time Updates**: WebSocket/SSE for live booking updates
6. **Multi-store Support**: Plan-based store limitations
7. **Staff/Resource Management**: Unified resource concept
8. **Customer Management**: LINE integration with manual data collection

### Testing Strategy (tugical_test_strategy_v1.0.md)
```yaml
Testing Pyramid:
  Unit Tests: 80%+ coverage target (PHPUnit, Jest)
  Integration Tests: All API endpoints (PHPUnit, Newman)
  E2E Tests: Critical paths 100% (Playwright, Cypress)
  Performance Tests: Load testing (k6, JMeter)
  Security Tests: OWASP compliance (ZAP, SonarQube)

Test Environment:
  - Automated CI/CD with GitHub Actions
  - Cross-browser testing (Chrome, Firefox, Safari)
  - Mobile device testing
  - Security scanning and dependency checks
```

### Deployment Strategy (tugical_deployment_guide_v1.0.md)
```yaml
VPS統一戦略:
  Initial: さくらのVPS 8GB (¥4,400/月)
  Environments: dev.tugical.com, staging.tugical.com, tugical.com
  Migration Trigger: >20 stores, >5000 bookings/month, >80% resource usage
  
CI/CD Pipeline:
  - develop branch → staging.tugical.com (automatic)
  - main branch → tugical.com (automatic)
  - GitHub Actions for testing and deployment
  - Blue-green deployment for production
  - Automated health checks and rollback
```

## Code Quality Rules (MANDATORY)

### Documentation Standards
- **All code must have Japanese comments**: Every function, class, and complex logic
- **PHPDoc blocks required**: All methods must have comprehensive PHPDoc
- **TypeScript interfaces with Japanese descriptions**: All types documented
- **README files**: Every major component/service needs README.md
- **Inline comments**: Explain "why" not "what" in Japanese

### Anti-Duplication Rules (CRITICAL FOR AI)
- **Check existing code first**: Before implementing any function, search for similar implementations
- **Use consistent naming patterns**: Follow established patterns exactly
- **Reuse existing utilities**: Never duplicate utility functions
- **Single responsibility**: One function = one purpose only
- **Extract common patterns**: If logic appears twice, create a shared service

### Testing Requirements
- **Unit Tests**: 80%+ code coverage for all business logic
- **Integration Tests**: All API endpoints must have tests
- **Feature Tests**: End-to-end user scenarios
- **Database Tests**: All model relationships and constraints
- **LIFF Tests**: Mock LINE SDK for frontend testing

## Framework Best Practices

### Laravel Best Practices
```php
// Architecture: Controller → Service → Repository → Model
class BookingController extends Controller
{
    public function __construct(
        private BookingService $bookingService
    ) {}

    /**
     * 予約作成API
     * 
     * @param CreateBookingRequest $request バリデーション済みリクエスト
     * @return JsonResponse 予約作成結果
     */
    public function store(CreateBookingRequest $request): JsonResponse
    {
        try {
            $booking = $this->bookingService->createBooking(
                storeId: $request->getStoreId(),
                bookingData: $request->validated()
            );
            
            return $this->successResponse(
                data: new BookingResource($booking),
                message: '予約が作成されました'
            );
        } catch (BookingConflictException $e) {
            return $this->errorResponse(
                message: $e->getMessage(),
                code: 'BOOKING_CONFLICT',
                status: 422
            );
        }
    }
}

class BookingService
{
    public function __construct(
        private BookingRepository $bookingRepository,
        private HoldTokenService $holdTokenService,
        private NotificationService $notificationService
    ) {}

    /**
     * 予約作成処理
     * 
     * @param int $storeId 店舗ID
     * @param array $bookingData 予約データ
     * @return Booking 作成された予約
     * @throws BookingConflictException 予約競合時
     * @throws HoldTokenExpiredException 仮押さえ期限切れ時
     */
    public function createBooking(int $storeId, array $bookingData): Booking
    {
        // 仮押さえトークン検証
        $this->holdTokenService->validateToken($bookingData['hold_token']);
        
        // 予約競合チェック
        if ($this->hasConflict($storeId, $bookingData)) {
            throw new BookingConflictException('指定時間は既に予約されています');
        }
        
        // 予約作成（トランザクション内）
        return DB::transaction(function () use ($storeId, $bookingData) {
            $booking = $this->bookingRepository->create($storeId, $bookingData);
            
            // 仮押さえトークンを削除
            $this->holdTokenService->releaseToken($bookingData['hold_token']);
            
            // 通知送信（非同期）
            $this->notificationService->sendBookingConfirmation($booking);
            
            return $booking;
        });
    }

    /**
     * 予約競合チェック
     * 
     * @param int $storeId 店舗ID
     * @param array $bookingData 予約データ
     * @return bool 競合がある場合true
     */
    private function hasConflict(int $storeId, array $bookingData): bool
    {
        return $this->bookingRepository->hasTimeConflict(
            storeId: $storeId,
            resourceId: $bookingData['resource_id'],
            date: $bookingData['booking_date'],
            startTime: $bookingData['start_time'],
            endTime: $bookingData['end_time']
        );
    }
}
```

### React Best Practices
```typescript
interface BookingFormProps {
  /** 店舗ID */
  storeId: number;
  /** 初期データ */
  initialData?: Partial<BookingFormData>;
  /** 予約完了時のコールバック */
  onBookingComplete: (booking: Booking) => void;
}

/**
 * 予約フォームコンポーネント
 * 管理者が予約を作成するためのフォーム
 */
const BookingForm: React.FC<BookingFormProps> = ({
  storeId,
  initialData,
  onBookingComplete
}) => {
  // カスタムフックで状態管理
  const {
    bookingData,
    isLoading,
    errors,
    updateBookingData,
    submitBooking
  } = useBookingForm(storeId, initialData);

  /**
   * フォーム送信処理
   */
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const booking = await submitBooking();
      onBookingComplete(booking);
    } catch (error) {
      console.error('予約作成エラー:', error);
    }
  };

  return (
    <motion.form 
      onSubmit={handleSubmit}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="booking-form bg-white rounded-lg shadow-md p-6"
    >
      {/* フォーム内容 */}
      <div className="space-y-4">
        <CustomerSelect 
          value={bookingData.customerId}
          onChange={(customerId) => updateBookingData({ customerId })}
          error={errors.customerId}
        />
        
        <MenuSelect
          value={bookingData.menuId}
          onChange={(menuId) => updateBookingData({ menuId })}
          error={errors.menuId}
        />
        
        <ResourceSelect
          value={bookingData.resourceId}
          onChange={(resourceId) => updateBookingData({ resourceId })}
          error={errors.resourceId}
        />
      </div>

      <div className="mt-6 flex justify-end gap-3">
        <Button variant="outline" type="button">
          キャンセル
        </Button>
        <Button 
          variant="primary" 
          type="submit" 
          loading={isLoading}
        >
          {isLoading ? '作成中...' : '予約作成'}
        </Button>
      </div>
    </motion.form>
  );
};

/**
 * 予約フォーム用カスタムフック
 * 状態管理と API呼び出しを統合
 */
const useBookingForm = (storeId: number, initialData?: Partial<BookingFormData>) => {
  const [bookingData, setBookingData] = useState<BookingFormData>({
    customerId: '',
    menuId: '',
    resourceId: '',
    bookingDate: '',
    startTime: '',
    notes: '',
    ...initialData
  });
  
  const [isLoading, setIsLoading] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});

  /**
   * 予約データ更新
   */
  const updateBookingData = useCallback((data: Partial<BookingFormData>) => {
    setBookingData(prev => ({ ...prev, ...data }));
    // エラーをクリア
    setErrors(prev => {
      const newErrors = { ...prev };
      Object.keys(data).forEach(key => delete newErrors[key]);
      return newErrors;
    });
  }, []);

  /**
   * 予約送信処理
   */
  const submitBooking = useCallback(async (): Promise<Booking> => {
    setIsLoading(true);
    setErrors({});
    
    try {
      const response = await bookingApi.create(storeId, bookingData);
      return response.data.booking;
    } catch (error: any) {
      if (error.response?.data?.error?.details) {
        setErrors(error.response.data.error.details);
      }
      throw error;
    } finally {
      setIsLoading(false);
    }
  }, [storeId, bookingData]);

  return {
    bookingData,
    isLoading,
    errors,
    updateBookingData,
    submitBooking
  };
};
```

### Multi-Tenant Awareness (CRITICAL)
```php
// ✅ 正しい実装：常にstore_id分離
class BookingRepository
{
    /**
     * 店舗の予約一覧取得
     * 
     * @param int $storeId 店舗ID
     * @param array $filters フィルター条件
     * @return Collection<Booking> 予約一覧
     */
    public function findByStore(int $storeId, array $filters = []): Collection
    {
        return Booking::where('store_id', $storeId) // 必須：テナント分離
            ->when($filters['date'] ?? null, fn($q, $date) => 
                $q->whereDate('booking_date', $date)
            )
            ->when($filters['status'] ?? null, fn($q, $status) => 
                $q->where('status', $status)
            )
            ->when($filters['resource_id'] ?? null, fn($q, $resourceId) => 
                $q->where('resource_id', $resourceId)
            )
            ->with(['customer:id,name,phone', 'menu:id,name', 'resource:id,name'])
            ->orderBy('booking_date')
            ->orderBy('start_time')
            ->get();
    }
    
    /**
     * 時間重複チェック
     * 
     * @param int $storeId 店舗ID
     * @param int $resourceId リソースID
     * @param string $date 予約日
     * @param string $startTime 開始時間
     * @param string $endTime 終了時間
     * @param int|null $excludeBookingId 除外する予約ID
     * @return bool 重複がある場合true
     */
    public function hasTimeConflict(
        int $storeId,
        int $resourceId,
        string $date,
        string $startTime,
        string $endTime,
        ?int $excludeBookingId = null
    ): bool {
        return Booking::where('store_id', $storeId) // 必須：テナント分離
            ->where('resource_id', $resourceId)
            ->whereDate('booking_date', $date)
            ->whereIn('status', ['confirmed', 'pending'])
            ->when($excludeBookingId, fn($q, $id) => $q->where('id', '!=', $id))
            ->where(function($query) use ($startTime, $endTime) {
                $query->whereBetween('start_time', [$startTime, $endTime])
                      ->orWhereBetween('end_time', [$startTime, $endTime])
                      ->orWhere(function($q) use ($startTime, $endTime) {
                          $q->where('start_time', '<=', $startTime)
                            ->where('end_time', '>=', $endTime);
                      });
            })
            ->exists();
    }
}

// ❌ 危険な実装：クロステナントアクセス可能
class BadRepository
{
    public function findAll(): Collection
    {
        return Booking::all(); // セキュリティリスク！store_id チェックなし
    }
    
    public function findById(int $id): ?Booking
    {
        return Booking::find($id); // 他店舗の予約も取得可能（危険）
    }
}

// Global Scope による自動店舗フィルタリング
class TenantScope implements Scope
{
    /**
     * テナントスコープの適用
     * 認証ユーザーのstore_idで自動フィルタリング
     */
    public function apply(Builder $builder, Model $model): void
    {
        if (auth()->check() && auth()->user()->store_id) {
            $builder->where($model->getTable() . '.store_id', auth()->user()->store_id);
        }
    }
}

// モデルでのスコープ適用
class Booking extends Model
{
    protected static function booted()
    {
        static::addGlobalScope(new TenantScope);
        
        // 作成時に自動でstore_id設定
        static::creating(function ($booking) {
            if (!$booking->store_id && auth()->check()) {
                $booking->store_id = auth()->user()->store_id;
            }
        });
    }
}
```

## API Design Standards (tugical_api_specification_v1.0.md)

### Response Format (統一)
```json
// 成功レスポンス
{
  "success": true,
  "data": {
    "booking": {
      "id": 123,
      "booking_number": "TG20250628001",
      "status": "confirmed",
      "customer": {
        "name": "山田太郎",
        "phone": "090-1234-5678"
      },
      "menu": {
        "name": "カット",
        "duration": 60
      },
      "total_price": 4500
    }
  },
  "message": "予約が完了しました",
  "meta": {
    "timestamp": "2025-06-28T10:00:00+09:00",
    "version": "1.0"
  }
}

// エラーレスポンス
{
  "success": false,
  "error": {
    "code": "BOOKING_CONFLICT",
    "message": "指定の時間は既に予約済みです",
    "details": {
      "conflicting_booking_id": 456,
      "suggested_times": ["14:30", "15:00", "15:30"]
    }
  },
  "meta": {
    "timestamp": "2025-06-28T10:00:00+09:00"
  }
}

// バリデーションエラー
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力内容に誤りがあります",
    "details": {
      "customer_id": "顧客を選択してください",
      "booking_date": "予約日は未来の日付を選択してください",
      "start_time": "開始時間を選択してください"
    }
  },
  "meta": {
    "timestamp": "2025-06-28T10:00:00+09:00"
  }
}
```

### Endpoint Design Pattern
```php
// Admin API Routes (Laravel)
Route::prefix('v1')->middleware(['auth:sanctum', 'tenant.scope'])->group(function () {
    // 予約管理
    Route::get('bookings', [BookingController::class, 'index']);
    Route::post('bookings', [BookingController::class, 'store']);
    Route::get('bookings/{booking}', [BookingController::class, 'show']);
    Route::put('bookings/{booking}', [BookingController::class, 'update']);
    Route::delete('bookings/{booking}', [BookingController::class, 'destroy']);
    Route::patch('bookings/{booking}/status', [BookingController::class, 'updateStatus']);
    
    // 空き時間・可用性
    Route::get('availability', [AvailabilityController::class, 'index']);
    Route::post('hold-slots', [HoldTokenController::class, 'create']);
    Route::delete('hold-slots/{token}', [HoldTokenController::class, 'release']);
    
    // 顧客管理
    Route::apiResource('customers', CustomerController::class);
    
    // リソース管理
    Route::apiResource('resources', ResourceController::class);
    
    // メニュー管理
    Route::apiResource('menus', MenuController::class);
    Route::apiResource('menus.options', MenuOptionController::class);
});

// LIFF API Routes
Route::prefix('v1/liff')->middleware(['line.verify', 'throttle:liff'])->group(function () {
    Route::get('stores/{slug}', [LiffController::class, 'getStore']);
    Route::get('stores/{slug}/menus', [LiffController::class, 'getMenus']);
    Route::get('stores/{slug}/resources', [LiffController::class, 'getResources']);
    Route::get('stores/{slug}/availability', [LiffController::class, 'getAvailability']);
    Route::post('stores/{slug}/hold-slots', [LiffController::class, 'createHoldSlot']);
    Route::post('stores/{slug}/bookings', [LiffController::class, 'createBooking']);
    Route::get('customers/profile', [LiffController::class, 'getCustomerProfile']);
    Route::get('customers/bookings', [LiffController::class, 'getCustomerBookings']);
});

// LINE Webhook
Route::post('v1/line/webhook', [LineWebhookController::class, 'handle'])
    ->middleware(['line.signature.verify']);

// Health Check
Route::get('health', function () {
    return response()->json([
        'status' => 'healthy',
        'timestamp' => now()->toISOString(),
        'environment' => app()->environment(),
    ]);
});
```

### Request/Response Classes
```php
// Form Request Example
class CreateBookingRequest extends FormRequest
{
    /**
     * バリデーションルール
     */
    public function rules(): array
    {
        return [
            'customer_id' => 'required|exists:customers,id',
            'menu_id' => 'required|exists:menus,id',
            'resource_id' => 'nullable|exists:resources,id',
            'booking_date' => 'required|date|after:today',
            'start_time' => 'required|date_format:H:i',
            'customer_notes' => 'nullable|string|max:500',
            'options' => 'array',
            'options.*' => 'exists:menu_options,id',
            'hold_token' => 'required|string',
        ];
    }

    /**
     * バリデーションメッセージ（日本語）
     */
    public function messages(): array
    {
        return [
            'customer_id.required' => '顧客を選択してください',
            'customer_id.exists' => '選択された顧客が見つかりません',
            'menu_id.required' => 'メニューを選択してください',
            'menu_id.exists' => '選択されたメニューが見つかりません',
            'booking_date.required' => '予約日を選択してください',
            'booking_date.after' => '予約日は未来の日付を選択してください',
            'start_time.required' => '開始時間を選択してください',
            'start_time.date_format' => '正しい時間形式で入力してください',
            'hold_token.required' => '仮押さえトークンが必要です',
        ];
    }

    /**
     * 店舗IDを取得
     */
    public function getStoreId(): int
    {
        return auth()->user()->store_id;
    }
}

// API Resource Example
class BookingResource extends JsonResource
{
    /**
     * 予約リソースの変換
     */
    public function toArray($request): array
    {
        return [
            'id' => $this->id,
            'booking_number' => $this->booking_number,
            'booking_date' => $this->booking_date,
            'start_time' => $this->start_time,
            'end_time' => $this->end_time,
            'status' => $this->status,
            'total_price' => $this->total_price,
            
            // 関連データ
            'customer' => new CustomerResource($this->whenLoaded('customer')),
            'menu' => new MenuResource($this->whenLoaded('menu')),
            'resource' => new ResourceResource($this->whenLoaded('resource')),
            'options' => MenuOptionResource::collection($this->whenLoaded('options')),
            
            // メタデータ
            'customer_notes' => $this->customer_notes,
            'staff_notes' => $this->staff_notes,
            'created_at' => $this->created_at?->toISOString(),
            'updated_at' => $this->updated_at?->toISOString(),
        ];
    }
}
```

## Error Handling & User Feedback

### Standardized Error Display
```typescript
// エラー表示コンポーネント
interface ErrorDisplayProps {
  level: 'info' | 'warning' | 'error' | 'success';
  message: string;
  details?: string;
  action?: {
    label: string;
    onClick: () => void;
  };
  autoHide?: number;
  onClose?: () => void;
}

/**
 * 統一エラー表示コンポーネント
 * Toast通知とインライン表示の両方に対応
 */
const ErrorDisplay: React.FC<ErrorDisplayProps> = ({
  level,
  message,
  details,
  action,
  autoHide,
  onClose,
}) => {
  const [isVisible, setIsVisible] = useState(true);

  // 自動非表示
  useEffect(() => {
    if (autoHide && autoHide > 0) {
      const timer = setTimeout(() => {
        setIsVisible(false);
        onClose?.();
      }, autoHide * 1000);
      return () => clearTimeout(timer);
    }
  }, [autoHide, onClose]);

  if (!isVisible) return null;

  const levelStyles = {
    info: 'bg-blue-50 border-blue-200 text-blue-800',
    warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
    error: 'bg-red-50 border-red-200 text-red-800',
    success: 'bg-green-50 border-green-200 text-green-800',
  };

  const iconMap = {
    info: '📊',
    warning: '⚠️',
    error: '❌',
    success: '✅',
  };

  return (
    <motion.div
      className={cn(
        'p-4 rounded-lg border',
        levelStyles[level]
      )}
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      exit={{ opacity: 0, scale: 0.95 }}
    >
      <div className="flex items-start">
        <span className="text-lg mr-3">{iconMap[level]}</span>
        <div className="flex-1">
          <p className="font-medium">{message}</p>
          {details && (
            <p className="mt-1 text-sm opacity-80">{details}</p>
          )}
          {action && (
            <button
              onClick={action.onClick}
              className="mt-2 text-sm underline hover:no-underline"
            >
              {action.label}
            </button>
          )}
        </div>
        {onClose && (
          <button
            onClick={() => {
              setIsVisible(false);
              onClose();
            }}
            className="ml-3 text-lg opacity-60 hover:opacity-100"
          >
            ×
          </button>
        )}
      </div>
    </motion.div>
  );
};

// Toast通知用プロバイダー
const ToastProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [toasts, setToasts] = useState<Array<{
    id: string;
    level: ErrorDisplayProps['level'];
    message: string;
    details?: string;
    action?: ErrorDisplayProps['action'];
  }>>([]);

  const addToast = useCallback((toast: Omit<typeof toasts[0], 'id'>) => {
    const id = Date.now().toString();
    setToasts(prev => [...prev, { ...toast, id }]);
  }, []);

  const removeToast = useCallback((id: string) => {
    setToasts(prev => prev.filter(toast => toast.id !== id));
  }, []);

  return (
    <ToastContext.Provider value={{ addToast, removeToast }}>
      {children}
      
      {/* Toast Container */}
      <div className="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
        <AnimatePresence>
          {toasts.map(toast => (
            <ErrorDisplay
              key={toast.id}
              level={toast.level}
              message={toast.message}
              details={toast.details}
              action={toast.action}
              autoHide={5}
              onClose={() => removeToast(toast.id)}
            />
          ))}
        </AnimatePresence>
      </div>
    </ToastContext.Provider>
  );
};

// 使用例
const useToast = () => {
  const context = useContext(ToastContext);
  if (!context) throw new Error('useToast must be used within ToastProvider');
  return context;
};

// コンポーネント内での使用
const BookingForm = () => {
  const { addToast } = useToast();

  const handleSubmit = async (data: BookingFormData) => {
    try {
      await bookingApi.create(data);
      addToast({
        level: 'success',
        message: '予約が作成されました',
        details: '確認メールを送信しました',
      });
    } catch (error: any) {
      addToast({
        level: 'error',
        message: '予約の作成に失敗しました',
        details: error.response?.data?.error?.message || 'しばらく時間をおいて再度お試しください',
        action: {
          label: '再試行',
          onClick: () => handleSubmit(data),
        },
      });
    }
  };
};
```

## Progress Documentation & Git Management

### Mandatory Progress Tracking
- **PROGRESS.md**: Always maintain current development status
- **Git commits**: Granular commits with descriptive Japanese messages
- **Branch strategy**: Feature branches with clear naming (feature/booking-service, fix/line-webhook)
- **Status updates**: After every major milestone, update documentation
- **Cross-device continuity**: Any team member can continue from any point

### Git Workflow for Continuity
```bash
# Feature development workflow
git checkout -b feature/booking-hold-system
git add .
git commit -m "feat(booking): 仮押さえシステムの基本実装

- HoldTokenService クラス作成
- 10分間の排他制御ロジック実装
- Redis による token 管理
- 基本的なバリデーション追加

Progress: app/Services/HoldTokenService.php 完了
Next: BookingService との統合実装"

# Always update progress documentation
git add docs/PROGRESS.md docs/CURRENT_FOCUS.md
git commit -m "docs: 仮押さえシステム実装進捗を更新"

# Push frequently for cross-device access
git push origin feature/booking-hold-system
```

### Context Preservation Files
```
docs/
├── PROGRESS.md                    # 全体進捗状況
├── DEVELOPMENT_LOG.md             # 日次開発ログ
├── CURRENT_FOCUS.md               # 現在の作業詳細
├── KNOWN_ISSUES.md                # 既知の問題一覧
├── NEXT_SESSIONS.md               # 次回作業予定
└── ENVIRONMENT_STATUS.md          # 環境セットアップ状況
```

## Environment Configuration

### VPS Environment Setup (tugical_deployment_guide_v1.0.md)
```bash
# Environment URLs
Development:   http://dev.tugical.com (http://localhost)
Staging:       https://staging.tugical.com  
Production:    https://tugical.com

# Database separation
tugical_dev      # 開発環境
tugical_staging  # ステージング環境
tugical_prod     # 本番環境

# Redis prefixes
dev:*      # 開発環境用キャッシュ
staging:*  # ステージング環境用キャッシュ
prod:*     # 本番環境用キャッシュ
```

### Environment Variables
```bash
# .env.development
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost
DB_DATABASE=tugical_dev
DB_USERNAME=tugical_dev
DB_PASSWORD=dev_password_123
REDIS_PREFIX=dev:
CACHE_PREFIX=tugical_dev
QUEUE_PREFIX=tugical_dev

# .env.staging
APP_ENV=staging
APP_DEBUG=false
APP_URL=https://staging.tugical.com
DB_DATABASE=tugical_staging
DB_USERNAME=tugical_staging
DB_PASSWORD=staging_password_456
REDIS_PREFIX=staging:
CACHE_PREFIX=tugical_staging
QUEUE_PREFIX=tugical_staging

# .env.production
APP_ENV=production
APP_DEBUG=false
APP_URL=https://tugical.com
DB_DATABASE=tugical_prod
DB_USERNAME=tugical_prod
DB_PASSWORD=prod_password_789
REDIS_PREFIX=prod:
CACHE_PREFIX=tugical_prod
QUEUE_PREFIX=tugical_prod
```

## Performance & Scalability

### Migration Readiness (VPS → Cloud)
```yaml
Migration Triggers:
  - Active stores: > 20
  - Monthly bookings: > 5,000
  - VPS resource usage: > 80%
  - Response time: > 3 seconds
  - Monthly revenue: > ¥500,000

Current Strategy: VPS統一運用 (¥4,400/月)
Future Strategy: Graduated cloud migration

Cost Analysis:
  VPS統一運用: ¥4,400/月
  従来混在運用: ¥17,200/月
  年間節約額: ¥154,000
```

### Performance Monitoring
```typescript
// パフォーマンス監視用ユーティリティ
class PerformanceMonitor {
  private static measurements: Map<string, number> = new Map();

  /**
   * パフォーマンス測定開始
   */
  static start(label: string): void {
    this.measurements.set(label, performance.now());
  }

  /**
   * パフォーマンス測定終了
   */
  static end(label: string): number {
    const startTime = this.measurements.get(label);
    if (!startTime) {
      console.warn(`No measurement started for label: ${label}`);
      return 0;
    }
    
    const duration = performance.now() - startTime;
    this.measurements.delete(label);
    
    // 閾値チェック
    this.checkThreshold(label, duration);
    
    return duration;
  }

  /**
   * パフォーマンス閾値チェック
   */
  private static checkThreshold(label: string, duration: number): void {
    const thresholds = {
      'liff-screen-load': 2000,
      'booking-operation': 3000,
      'admin-dashboard': 1000,
      'api-request': 1000,
    };

    const threshold = thresholds[label];
    if (threshold && duration > threshold) {
      console.warn(`Performance warning: ${label} took ${duration.toFixed(2)}ms (threshold: ${threshold}ms)`);
      
      // 本番環境では監視システムに送信
      if (process.env.NODE_ENV === 'production') {
        // Send to monitoring system
        this.sendToMonitoring(label, duration, threshold);
      }
    }
  }

  /**
   * 監視システムにデータ送信
   */
  private static sendToMonitoring(label: string, duration: number, threshold: number): void {
    // Implement monitoring system integration
    fetch('/api/v1/monitoring/performance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        metric: label,
        duration,
        threshold,
        timestamp: new Date().toISOString(),
        user_agent: navigator.userAgent,
        url: window.location.href,
      }),
    }).catch(console.error);
  }
}

// 使用例
// LIFF画面ロード時間測定
useEffect(() => {
  PerformanceMonitor.start('liff-screen-load');
  
  // LIFF初期化完了後
  const duration = PerformanceMonitor.end('liff-screen-load');
  console.log(`LIFF screen loaded in ${duration.toFixed(2)}ms`);
}, []);

// API呼び出し時間測定
const bookingApi = {
  async create(data: BookingFormData) {
    PerformanceMonitor.start('booking-operation');
    try {
      const response = await fetch('/api/v1/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      return await response.json();
    } finally {
      PerformanceMonitor.end('booking-operation');
    }
  }
};
```

## Security & Compliance

### Data Protection Implementation
```php
// Multi-tenant data isolation middleware
class TenantScopeMiddleware
{
    /**
     * テナントスコープの強制適用
     */
    public function handle(Request $request, Closure $next)
    {
        $user = auth()->user();
        
        if (!$user || !$user->store_id) {
            return response()->json([
                'success' => false,
                'error' => [
                    'code' => 'UNAUTHORIZED',
                    'message' => '認証が必要です'
                ]
            ], 401);
        }

        // グローバルスコープでstore_id制限を強制
        DB::listen(function ($query) use ($user) {
            // 危険なクエリの検出
            if (strpos($query->sql, 'store_id') === false && 
                !in_array($query->connectionName, ['system', 'logs'])) {
                Log::warning('Potential cross-tenant query detected', [
                    'sql' => $query->sql,
                    'bindings' => $query->bindings,
                    'user_id' => $user->id,
                    'store_id' => $user->store_id,
                    'route' => request()->route()?->getName(),
                ]);
            }
        });

        return $next($request);
    }
}

// 個人情報暗号化
class PersonalDataEncryption
{
    /**
     * 個人情報の暗号化
     */
    public static function encrypt(string $data): string
    {
        return encrypt($data);
    }

    /**
     * 個人情報の復号化
     */
    public static function decrypt(string $encryptedData): string
    {
        try {
            return decrypt($encryptedData);
        } catch (DecryptException $e) {
            Log::error('Failed to decrypt personal data', [
                'error' => $e->getMessage(),
                'encrypted_data' => substr($encryptedData, 0, 50) . '...',
            ]);
            throw new SecurityException('個人情報の復号化に失敗しました');
        }
    }
}

// Model での自動暗号化
class Customer extends Model
{
    protected $fillable = [
        'store_id', 'line_user_id', 'name', 'phone', 'email', 'address'
    ];

    /**
     * 暗号化対象のフィールド
     */
    protected $encrypted = ['phone', 'email', 'address'];

    /**
     * データ設定時の自動暗号化
     */
    public function setAttribute($key, $value)
    {
        if (in_array($key, $this->encrypted) && $value !== null) {
            $value = PersonalDataEncryption::encrypt($value);
        }
        
        return parent::setAttribute($key, $value);
    }

    /**
     * データ取得時の自動復号化
     */
    public function getAttribute($key)
    {
        $value = parent::getAttribute($key);
        
        if (in_array($key, $this->encrypted) && $value !== null) {
            $value = PersonalDataEncryption::decrypt($value);
        }
        
        return $value;
    }
}
```

### Monitoring & Logging
```php
// ビジネスアクション監査ログ
class AuditLogger
{
    /**
     * 予約関連アクションのログ記録
     */
    public static function bookingAction(string $action, Booking $booking, ?User $user = null): void
    {
        $user = $user ?? auth()->user();
        
        Log::info("予約{$action}", [
            'action' => $action,
            'booking_id' => $booking->id,
            'booking_number' => $booking->booking_number,
            'store_id' => $booking->store_id,
            'customer_id' => $booking->customer_id,
            'user_id' => $user?->id,
            'user_type' => $user ? get_class($user) : 'system',
            'ip_address' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'timestamp' => now()->toISOString(),
        ]);
    }

    /**
     * セキュリティイベントのログ記録
     */
    public static function securityEvent(string $event, array $context = []): void
    {
        Log::warning("セキュリティイベント: {$event}", array_merge([
            'event' => $event,
            'ip_address' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'route' => request()->route()?->getName(),
            'method' => request()->method(),
            'url' => request()->fullUrl(),
            'user_id' => auth()->id(),
            'timestamp' => now()->toISOString(),
        ], $context));
    }
}

// 使用例
class BookingService
{
    public function createBooking(int $storeId, array $bookingData): Booking
    {
        $booking = DB::transaction(function () use ($storeId, $bookingData) {
            $booking = $this->bookingRepository->create($storeId, $bookingData);
            
            // 監査ログ記録
            AuditLogger::bookingAction('作成', $booking);
            
            return $booking;
        });

        return $booking;
    }
}

// 認証失敗時のログ記録
class LoginController extends Controller
{
    public function login(LoginRequest $request)
    {
        if (!Auth::attempt($request->validated())) {
            // セキュリティイベント記録
            AuditLogger::securityEvent('ログイン失敗', [
                'email' => $request->email,
                'attempt_ip' => $request->ip(),
            ]);
            
            return response()->json([
                'success' => false,
                'error' => [
                    'code' => 'INVALID_CREDENTIALS',
                    'message' => 'メールアドレスまたはパスワードが正しくありません'
                ]
            ], 401);
        }

        // 成功ログ
        AuditLogger::securityEvent('ログイン成功', [
            'user_id' => Auth::id(),
        ]);

        return response()->json([
            'success' => true,
            'data' => [
                'token' => Auth::user()->createToken('admin')->plainTextToken,
                'user' => new UserResource(Auth::user()),
            ]
        ]);
    }
}
```

## Current Development Status

### Implemented Components
- [x] Project structure defined
- [x] Documentation complete (requirements, database, API, deployment, testing, UI)
- [x] Architecture rules established
- [x] Development workflow defined
- [x] Mock screens created (11 screens)
- [x] Docker environment configured
- [x] VPS deployment strategy established

### Next Implementation Priority
1. **Docker Environment Setup**: Complete docker-compose.yml and related configs
2. **Database Migrations**: Implement tugical_database_design_v1.0.md exactly
3. **Core Models**: Create models with proper relationships and scopes
4. **Business Services**: BookingService, AvailabilityService, HoldTokenService
5. **API Layer**: Controllers and routes following tugical_api_specification_v1.0.md
6. **Frontend Components**: React components following tugical_ui_design_system_v1.0.md
7. **LIFF Integration**: LINE SDK integration and booking flow
8. **Testing Suite**: Implement tugical_test_strategy_v1.0.md

### Development Goals
- **Week 1**: Complete Docker setup + backend foundation (models, services, APIs)
- **Week 2**: Implement frontend admin dashboard
- **Week 3**: Build LIFF booking flow
- **Week 4**: Integration testing and deployment setup

## Remember - This is Production SaaS
- Focus on reliability and user experience above all
- Implement comprehensive monitoring and alerting
- Plan for horizontal scalability from day one
- Always consider multi-tenant data isolation
- Implement proper backup and disaster recovery
- Follow Japanese data protection laws
- Implement proper customer support tools
- Plan for high availability and load balancing

## AI Development Instructions
1. **Always read existing documentation first**: tugical_requirements_specification_v1.0.md, tugical_database_design_v1.0.md, etc.
2. **Follow established patterns exactly**: Don't deviate from documented architecture
3. **Implement complete, working code**: No TODOs or partial implementations
4. **Include comprehensive Japanese comments**: Every function documented
5. **Generate corresponding tests**: Follow tugical_test_strategy_v1.0.md
6. **Update progress documentation**: Always update PROGRESS.md and CURRENT_FOCUS.md
7. **Follow multi-tenant rules strictly**: Never allow cross-tenant data access
8. **Use proper error handling**: Implement custom exceptions and user-friendly messages
9. **Reference mock screens**: Use the 11 implemented mock screens as visual guides
10. **Performance first**: Always consider the performance requirements (2-3 second targets)

**Current Development Location**: /User/tugi/docker/tugical/
**Active Branch**: main (ready for feature branches)
**Next Major Task**: Docker environment setup and database migration implementation

**Critical Success Factors**:
- Multi-tenant security (store_id isolation)
- LIFF performance (< 2 second load time)
- Real-time booking updates
- Industry template flexibility
- VPS → Cloud migration readiness

### Development Branch Flow (開発フロー)
1. **作業開始前**
   - `git branch` で **develop** ブランチにいることを確認
   - `git pull origin develop` で最新状態に更新
2. **develop ブランチ** で機能開発・ローカルテスト実施
3. 進捗ドキュメント (`docs/PROGRESS.md` など) を更新
4. `git add .` → `git commit -m "feat: xxx"` → `git push origin develop`
5. Pull Request で **ユーザー確認 / コードレビュー**
6. 承認後 **main ブランチ** へマージ（GitHub UI もしくは CLI）
7. 作業が続く場合は `git checkout develop` で戻り、新タスクを開始

## 📞 連絡・確認事項
- **重要な変更** は必ずユーザーに事前確認を取ること
- 不明点や仕様に迷いがある場合は **積極的に質問** して解消すること
- 進捗や問題点は **透明性を持って随時報告** すること

## 🧠 メモリー活用必須
- **重要発見時**: 必ず`update_memory`ツールで記録（特にシステム設計・権限管理・データベース構造）
- **仕様変更時**: 既存メモリーの更新・削除を実行
- **新機能発見時**: 技術的制約・ビジネスルールを詳細記録
- **エラー解決時**: 解決方法と原因をメモリーに保存

#### 📊 進捗管理
- **ファイル**: `/Users/tugi/docker/tugical/docs/PROGRESS.md`
- **更新**: 作業完了時に必ず更新
- **記載内容**:
  - 現在日時（例: `2025-07-02`）
  - 作業端末（例: `tugiMacMini.local`）
  - 変更ファイル
  - コミットハッシュ
  - 次回予定