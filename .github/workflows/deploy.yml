# develop ãƒ—ãƒƒã‚·ãƒ¥ â†’ /var/www/laravel/tugical_dev ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
# main ãƒ—ãƒƒã‚·ãƒ¥     â†’ /var/www/laravel/tugical_app ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
# protectlabo ã® deploy.yml ã‚’å‚è€ƒã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»æ¡ä»¶ä»˜ãä¾å­˜æ›´æ–°ãƒ»migrate ã‚’æ•´ç†
#
# å¿…é ˆ Secretsï¼ˆãƒªãƒã‚¸ãƒˆãƒªè¨­å®š â†’ Secrets and variables â†’ Actionsï¼‰:
#   develop ç”¨: TEST_HOST, TEST_USER, TEST_SSH_KEY
#   main ç”¨:   PROD_HOST, PROD_USER, PROD_SSH_KEY

name: Deploy to Server

on:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:

jobs:
  deploy-test:
    name: Deploy to tugical_dev (develop)
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Test Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_HOST }}
          username: ${{ secrets.TEST_USER }}
          key: ${{ secrets.TEST_SSH_KEY }}
          script: |
            cd /var/www/laravel/tugical_dev

            echo "ğŸš€ Deploying to DEVELOPMENT environment"
            echo "Current branch: $(git branch --show-current)"

            git fetch origin
            git reset --hard origin/develop
            git clean -fd

            if [ ! -d "vendor" ] || [ "composer.lock" -nt "vendor/autoload.php" ]; then
              composer install --no-dev --optimize-autoloader --no-interaction
              echo "âœ… Composerä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°å®Œäº†"
            else
              echo "âœ… Composerä¾å­˜é–¢ä¿‚ã¯æœ€æ–°ã§ã™"
            fi

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20 2>/dev/null || true
            if [ ! -d "node_modules" ] || [ "package-lock.json" -nt "node_modules/.package-lock.json" ]; then
              npm ci --prefer-offline --no-audit --no-fund
              echo "âœ… NPMä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°å®Œäº†"
            else
              echo "âœ… NPMä¾å­˜é–¢ä¿‚ã¯æœ€æ–°ã§ã™"
            fi

            NODE_OPTIONS="--max-old-space-size=4096" npm run build

            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            if php artisan migrate:status | grep -q "Pending"; then
              php artisan migrate --force
              echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå®Œäº†"
            else
              echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æœ€æ–°ã§ã™"
            fi

            php artisan storage:link 2>/dev/null || echo "âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"

            if [ -w storage ] && [ -w bootstrap/cache ]; then
              chown -R www-data:www-data storage bootstrap/cache 2>/dev/null || true
              chmod -R 775 storage bootstrap/cache 2>/dev/null || true
              echo "âœ… æ¨©é™è¨­å®šå®Œäº†"
            else
              echo "âš ï¸  æ¨©é™è¨­å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¨©é™ä¸è¶³ï¼‰"
            fi

            echo "âœ… Development deployment completed successfully!"

  deploy-production:
    name: Deploy to tugical_app (main)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /var/www/laravel/tugical_app

            echo "ğŸš€ Deploying to PRODUCTION environment"
            echo "Current branch: $(git branch --show-current)"

            git fetch origin
            git reset --hard origin/main
            git clean -fd

            if [ ! -d "vendor" ] || [ "composer.lock" -nt "vendor/autoload.php" ]; then
              composer install --no-dev --optimize-autoloader --no-interaction
              echo "âœ… Composerä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°å®Œäº†"
            else
              echo "âœ… Composerä¾å­˜é–¢ä¿‚ã¯æœ€æ–°ã§ã™"
            fi

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20 2>/dev/null || true
            if [ ! -d "node_modules" ] || [ "package-lock.json" -nt "node_modules/.package-lock.json" ]; then
              npm ci --prefer-offline --no-audit --no-fund
              echo "âœ… NPMä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°å®Œäº†"
            else
              echo "âœ… NPMä¾å­˜é–¢ä¿‚ã¯æœ€æ–°ã§ã™"
            fi

            NODE_OPTIONS="--max-old-space-size=4096" npm run build

            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            if php artisan migrate:status | grep -q "Pending"; then
              php artisan migrate --force
              echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå®Œäº†"
            else
              echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æœ€æ–°ã§ã™"
            fi

            php artisan storage:link 2>/dev/null || echo "âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"

            if [ -w storage ] && [ -w bootstrap/cache ]; then
              chown -R www-data:www-data storage bootstrap/cache 2>/dev/null || true
              chmod -R 775 storage bootstrap/cache 2>/dev/null || true
              echo "âœ… æ¨©é™è¨­å®šå®Œäº†"
            else
              echo "âš ï¸  æ¨©é™è¨­å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¨©é™ä¸è¶³ï¼‰"
            fi

            echo "âœ… Production deployment completed successfully!"
