# 管理画面 認証・ロール・ダッシュボード 仕様書 v1.0（MVP Aフェーズ）

**Version**: 1.0  
**Date**: 2025-02-11  
**Project**: tugical（ツギカル）  
**Phase**: MVP A（予約を迷わず完走できる）

---

## 1. 目的

本仕様は、**運用安全性を高めるための整理**であり、機能追加ではない。

- 認証・ロール・ダッシュボードの扱いを MVP 範囲で明文化する。
- 単店舗前提（1契約=1店舗）を守る。
- 将来の B フェーズ（売上最大化・複数店舗等）に拡張できる構造を壊さない。
- 実装可能なレベルまで具体化する。

**正とするドキュメント**:  
tugical_project_overview.md / CONCEPT_SPEC_FIT_GAP.md / tugical_requirements_specification_v1.1.md / admin_auth_and_role_dashboard_requirements_v1.0.md

---

## 2. 適用範囲（MVP 内）

| 対象 | 範囲 |
|------|------|
| 認証 | 店舗管理者（User + store_id）のログイン・ログアウト・トークン認証のみ |
| ロール | owner / manager / staff / reception の 4 種。表示制御のみ。ルーティング分岐は行わない。 |
| ダッシュボード | 表示ブロックの出し分け。既存テーブル・既存 API のみ使用。新規集計ロジック・新規 API は作らない。 |
| URL | `/admin/login` と `/admin/dashboard` のみ。これ以外の URL は増やさない。 |

**本仕様で行わないこと**:  
新しいビジネスロジックの追加、売上最大化機能、複数店舗機能、tenant 管理、業種分岐、URL の追加、API の追加。

---

## 3. 認証仕様

### 3.1 認証方式

- **トークン認証**（Laravel Sanctum API Token）を使用する。
- セッション（Cookie）認証は使用しない。管理画面 SPA は Bearer トークンで API にアクセスする。

### 3.2 ログイン処理フロー

1. ユーザーが `/admin/login`（SPA 内パスは `/login`）で、メール・パスワード・**store_id**（店舗選択）を入力する。
2. フロントは `POST /api/v1/auth/login` に上記を送信する。
3. バックエンドは `users` テーブルで `email` + `store_id` でユーザーを特定し、パスワードを検証する。
4. 検証成功時: 既存トークンを削除し、新規 Sanctum トークンを発行。`UserResource` でユーザー情報（id, name, email, role, store_id, permissions_summary 等）と店舗情報を返却する。
5. フロントはトークン・ユーザー・店舗を保持（例: authStore + persist）し、`/dashboard` へ遷移する。
6. 検証失敗時: 401 または 403 を返し、フロントはログイン画面に留まる。

※ ログイン API の詳細は既存の AuthController および tugical_api_specification に従う。本仕様ではフローと役割のみ定義する。

### 3.3 ログアウト処理

1. フロントは `POST /api/v1/auth/logout` を呼び出す（Bearer トークン付き）。
2. バックエンドは当該ユーザーの Sanctum トークンを削除する。
3. フロントはローカル状態（authStore）をクリアし、`/login` へリダイレクトする。

### 3.4 トークン有効期限

- **Sanctum のデフォルト**: `config/sanctum.php` の `expiration` が `null` の場合はトークンは無期限。
- MVP では **有効期限は変更しない**。必要に応じて将来、`expiration` を分数で設定する（B フェーズ以降の検討事項とする）。

### 3.5 store_id のスコープ制御方法

- **単店舗前提**: 1 契約 = 1 店舗。マルチテナント（複数店舗横断）は扱わない。
- ログイン時に指定した **store_id** と、`users.store_id` が一致するユーザーのみログイン可能。
- 認証済みリクエストでは、**すべての管理者 API で `auth()->user()->store_id` をスコープ**に用いる。
- 既存の **TenantScope**（Global Scope）および各 Controller の `auth()->user()->store_id` による絞り込みを変更せず、そのまま維持する。
- 他店舗のデータを参照・更新するリクエストは許可しない（スコープ外の resource/booking 等へのアクセスは 403 とする既存実装を維持）。

---

## 4. ロール仕様（MVP 範囲）

### 4.1 対象ロール

| role | 説明 | 判定元 |
|------|------|--------|
| owner | オーナー | `users.role` |
| manager | マネージャー | `users.role` |
| staff | スタッフ | `users.role` |
| reception | 受付 | `users.role` |

- **ロール判定方法**: 必ず **サーバーから返却された `user.role`**（および `user.permissions_summary`）を用いる。クライアント単独でロールを決定しない。
- **権限分岐**: **表示制御のみ**とする。ルーティング分岐（ロール別に異なる URL へ振り分ける）は行わない。全ロールとも `/login` と `/dashboard` のみを使用する。

### 4.2 各ロールが閲覧可能なブロック

| 表示ブロック | owner | manager | staff | reception |
|--------------|-------|---------|-------|-----------|
| 今日の予約 | ○ | ○ | ○ | ○ |
| アクティビティタイムライン | ○ | ○ | ○ | ○ |
| 売上サマリー | ○ | ○ | × | × |
| 総顧客数・今月の新規 | ○ | ○ | × | × |
| リソース稼働率 | ○ | ○ | × | × |
| 分析・グラフ | ○ | ○ | × | × |
| 設定への導線（サイドナビ「設定」） | ○ | × | × | × |

- 表示可否は **`user.permissions_summary`** に基づく。  
  - `can_view_analytics === true` → 売上・顧客数・稼働率・分析ブロックを表示。  
  - `can_manage_settings === true` → サイドナビに「設定」を表示。

### 4.3 編集可能な範囲（MVP での整理）

- **API 側**: 既存どおり、すべての管理者 API は `auth:sanctum` と `store_id` スコープのみで制御する。ロールによる API レベルの編集制限は **MVP では追加しない**（既存構造内の整理に留める）。
- **画面側**: 「設定」メニューは `can_manage_settings === true` のときのみ表示する。表示しないロールは設定画面の URL を直叩きしても、ナビには出さない（必要に応じて将来、API で設定変更をロール制限する拡張は B フェーズで検討）。

### 4.4 permissions_summary の参照

- ロールに応じた表示制御には、ログイン時および `GET /api/v1/auth/user` で返却される **`permissions_summary`** を用いる。
- 中身は既存の `UserResource::getPermissionsSummary()` に準拠する（can_manage_users, can_manage_settings, can_view_analytics 等）。MVP ではこの構造を変更しない。

---

## 5. ダッシュボード仕様

### 5.1 表示ブロック一覧

| ブロック | 内容 | 表示条件（ロール） |
|----------|------|---------------------|
| 今日の予約 | 本日の予約件数・リスト（既存予約データの表示） | 全ロール |
| アクティビティタイムライン | 直近の予約・顧客関連の動き | 全ロール |
| 売上サマリー | 本日・今週・今月の売上（既存予約データの集計） | owner, manager |
| 総顧客数・今月の新規 | 顧客数と今月の新規数 | owner, manager |
| リソース稼働率 | リソース数と稼働状況（既存予約・リソースの集計） | owner, manager |
| 分析・グラフ | 簡易な傾向（既存データの集計のみ） | owner, manager |
| 設定への導線 | サイドナビの「設定」リンク | owner のみ |

### 5.2 ブロックの表示条件

- 表示条件は **4.2 各ロールが閲覧可能なブロック** に従う。
- 判定はフロントで `user.role` および `user.permissions_summary` を用いて行う。同一 URL（`/dashboard`）内でブロックの表示・非表示を切り替える。

### 5.3 データ取得元（既存のみ）

- **新規 API は追加しない**。既存の API および既存テーブルのみを使用する。
- 想定する取得元の例（いずれも既存）:
  - **今日の予約**: `GET /api/v1/bookings`（日付パラメータで本日分を取得）など、既存の予約一覧 API。
  - **顧客数**: `GET /api/v1/customers` のメタ情報または既存の一覧 API で取得可能な範囲。
  - **リソース**: `GET /api/v1/resources` など既存のリソース API。
  - **売上・稼働率・分析**: 既存の `bookings` 等のデータを、**既存 API で取得した結果をフロントで集計**するか、既存の統計系エンドポイントがあればそれを使用する。**新規の集計用 API は作成しない**。
- ※ フロントに `/dashboard/stats` や `/dashboard/activity` を呼ぶ実装がある場合、バックエンドに該当ルートが存在しないなら、上記の既存 API の組み合わせで代替する。

### 5.4 将来拡張（B フェーズ）との切り分け

- **B フェーズで行う想定のため、MVP では実装しない**:
  - 売上最大化のための分析・KPI・レポート。
  - 業種別 KPI・業種別ダッシュボード。
  - 複数店舗・テナント横断のダッシュボード。
  - ダッシュボード専用の新規 API（例: 集計専用エンドポイント）の追加。
- 上記は仕様・コード内にコメントで「将来拡張」と明示し、A フェーズでは手を入れない。

---

## 6. セキュリティ設計

### 6.1 store_id 強制スコープ

- すべての管理者向け API は **認証ユーザーの `store_id` でスコープ**する。
- TenantScope および各 Controller での `auth()->user()->store_id` による条件付けを維持する。  
  store_id をリクエストで上書きさせない（ログイン時に決まった store_id のみ有効）。

### 6.2 他店舗データ参照不可

- 他店舗（`store_id` が認証ユーザーと異なる）の予約・顧客・メニュー・リソース・設定へのアクセスは **禁止**とする。
- 既存実装（リソース取得時の `store_id` 一致チェック、403 返却）を変更せず維持する。

### 6.3 ロール改ざん対策（サーバー側チェック必須）

- ロールは **常にサーバー側の `users.role` に基づく**。クライアントからロールや権限を送信して変更することは認めない。
- ログインおよび `GET /api/v1/auth/user` のレスポンスで返却する `role` および `permissions_summary` を正とする。
- 将来、設定変更やユーザー管理などで「ロールによって実行可能な操作」を制限する場合は、**各 API 内で `auth()->user()->role` を参照して 403 を返す**形で実装する。MVP では表示制御のみとし、API の実行可否のロール制限は既存範囲に留める。

---

## 7. 将来拡張（B フェーズ）との切り分け

| 項目 | A フェーズ（本仕様） | B フェーズ（将来） |
|------|----------------------|---------------------|
| 認証 | トークン・単店舗・店舗管理者のみ | テナント管理者・複数店舗切り替え等 |
| ロール | 4 ロール・表示制御のみ | API 実行可否のロール制限・RBAC 拡張 |
| ダッシュボード | 既存 API のみ・既存データの表示・簡易集計 | 売上分析・KPI・レポート・新規集計 API |
| URL | `/admin/login`, `/admin/dashboard` のみ | ロール別 URL やテナント用画面の追加は検討 |
| 店舗 | 1 契約 = 1 店舗 | 複数店舗・tenant 管理 |

本仕様は **A フェーズの範囲のみ** を定義する。B フェーズの機能には一切触れない。

---

## 8. 実装時の自問（スコープ確認）

仕様に迷った場合は、以下を確認する。

- これは **予約完走に必要か？**  
- これは **B フェーズに属さないか？**  
- **URL や API・構造を増やしていないか？**

3 つとも Yes でない場合は、本仕様には含めない。

---

**以上、管理画面の認証・ロール・ダッシュボード構成の MVP（A フェーズ）仕様とする。**
