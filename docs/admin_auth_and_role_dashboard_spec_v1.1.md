# 管理画面 認証・ロール・ダッシュボード 仕様書 v1.1（MVP Aフェーズ）

**Version**: 1.1  
**Date**: 2025-02-11  
**Project**: tugical（ツギカル）  
**Phase**: MVP A（予約を迷わず完走できる）

---

## 1. 目的

本仕様は、**運用安全性を高める整理**であり、機能追加ではない。

- 認証・ロール・ダッシュボードの扱いを MVP 範囲で明文化する。
- ダッシュボードの目的を **「見るだけ」ではなく「行動を促す」** に据え、既存予約データの**表示設計**で「次に何をすべきか」が分かる構成とする。
- 単店舗前提（1契約=1店舗）を守る。
- 将来の B フェーズ（売上最大化・複数店舗等）に拡張できる構造を壊さない。
- 実装可能なレベルまで具体化する。

**正とするドキュメント**:  
tugical_project_overview.md / CONCEPT_SPEC_FIT_GAP.md / tugical_requirements_specification_v1.1.md / admin_auth_and_role_dashboard_requirements_v1.0.md / admin_auth_and_role_dashboard_spec_v1.0.md

---

## 2. 適用範囲（MVP 内）

| 対象 | 範囲 |
|------|------|
| 認証 | 店舗管理者（User + store_id）のログイン・ログアウト・トークン認証のみ |
| ロール | owner / manager / staff / reception の 4 種。表示制御のみ。ルーティング分岐は行わない。 |
| ダッシュボード | **行動を促す表示設計**。必須ブロック 3 種 + ロール別出し分け。既存テーブル・既存 API のみ。新規集計ロジック・新規 API は原則作らない。 |
| URL | `/admin/login` と `/admin/dashboard` のみ。これ以外の URL は増やさない。 |

**本仕様で行わないこと**:  
新しいビジネスロジックの追加、売上最大化機能、複数店舗機能、tenant 管理、業種分岐、URL の追加、API の追加（必要なら既存データ取得の範囲で最小にとどめる）。

---

## 3. 認証仕様

### 3.1 認証方式

- **トークン認証**（Laravel Sanctum API Token）を使用する。
- セッション（Cookie）認証は使用しない。管理画面 SPA は Bearer トークンで API にアクセスする。

### 3.2 ログイン処理フロー

1. ユーザーが `/admin/login`（SPA 内パスは `/login`）で、メール・パスワード・**store_id**（店舗選択）を入力する。
2. フロントは `POST /api/v1/auth/login` に上記を送信する。
3. バックエンドは `users` テーブルで `email` + `store_id` でユーザーを特定し、パスワードを検証する。
4. 検証成功時: 既存トークンを削除し、新規 Sanctum トークンを発行。`UserResource` でユーザー情報（id, name, email, role, store_id, permissions_summary 等）と店舗情報を返却する。
5. フロントはトークン・ユーザー・店舗を保持（例: authStore + persist）し、`/dashboard` へ遷移する。
6. 検証失敗時: 401 または 403 を返し、フロントはログイン画面に留まる。

※ ログイン API の詳細は既存の AuthController および tugical_api_specification に従う。

### 3.3 ログアウト処理

1. フロントは `POST /api/v1/auth/logout` を呼び出す（Bearer トークン付き）。
2. バックエンドは当該ユーザーの Sanctum トークンを削除する。
3. フロントはローカル状態（authStore）をクリアし、`/login` へリダイレクトする。

### 3.4 トークン有効期限

- **Sanctum のデフォルト**: `config/sanctum.php` の `expiration` が `null` の場合はトークンは無期限。
- MVP では **有効期限は変更しない**。

### 3.5 store_id のスコープ制御方法

- **単店舗前提**: 1 契約 = 1 店舗。
- ログイン時に指定した **store_id** と、`users.store_id` が一致するユーザーのみログイン可能。
- 認証済みリクエストでは、**すべての管理者 API で `auth()->user()->store_id` をスコープ**に用いる。既存の TenantScope および各 Controller の `auth()->user()->store_id` による絞り込みを維持する。
- 他店舗のデータを参照・更新するリクエストは許可しない。

---

## 4. ロール仕様（MVP 範囲）

### 4.1 対象ロール

| role | 説明 | 判定元 |
|------|------|--------|
| owner | オーナー | `users.role` |
| manager | マネージャー | `users.role` |
| staff | スタッフ | `users.role` |
| reception | 受付 | `users.role` |

- **ロール判定方法**: 必ず **サーバーから返却された `user.role`**（および `user.permissions_summary`）を用いる。
- **権限分岐**: **表示制御のみ**。ルーティング分岐は行わない。全ロールとも `/login` と `/dashboard` のみを使用する。

### 4.2 permissions_summary の参照

- ロールに応じた表示制御には、ログイン時および `GET /api/v1/auth/user` で返却される **`permissions_summary`** を用いる。
- 既存の `UserResource::getPermissionsSummary()` に準拠する（can_manage_users, can_manage_settings, can_view_analytics 等）。MVP ではこの構造を変更しない。

### 4.3 編集可能な範囲（MVP）

- **API 側**: 既存どおり、すべての管理者 API は `auth:sanctum` と `store_id` スコープのみで制御。ロールによる API レベルの編集制限は **追加しない**。
- **画面側**: 「設定」メニューは `can_manage_settings === true` のときのみ表示する。

---

## 5. ダッシュボード仕様（行動を促す設計）

### 5.1 ダッシュボードの目的

- **目的**: 「見るだけのダッシュボード」ではなく **「行動を促すダッシュボード」** とする。
- 開いた人が **次に何をすべきか** が分かり、**どこを押せばそのアクションに進めるか** が明確であること。
- 機能追加は行わない。**既存予約データの表示設計**（並び順・強調・ラベル・導線）で行動を促す。

### 5.2 必須ブロック（3 種）

以下をダッシュボードの必須ブロックとして定義する。いずれも既存の `bookings`（および必要に応じて `customers`）の取得結果から表示する。

| # | ブロック名 | 役割 | 表示内容の要点 |
|---|------------|------|----------------|
| 1 | **今日の予約タイムライン** | 「今・次」が分かる | 本日の予約を時間軸で表示。**次の予約**（現在時刻から見て直近の未完了予約）を視覚的に強調する。各予約から「予約詳細・編集」への導線（クリックで予約管理へ）を用意する。 |
| 2 | **要対応アクション** | 例外・アラートで漏れを防ぐ | 「例外の条件」を満たした予約・事象をリスト表示。1 件ごとに「確認する」「対応する」などの導線を付与。0 件のときは「要対応はありません」と表示してよい。 |
| 3 | **直近の変更・キャンセル** | 確認導線 | 直近でステータス変更・キャンセルされた予約をリスト表示。内容確認・必要なら顧客連絡などの導線（予約詳細・顧客詳細へのリンク）を付与する。 |

- データ取得は **既存 API のみ**（例: `GET /api/v1/bookings` に日付・ステータス等のパラメータで取得）。新規 API は原則作らない。必要なら既存データ取得の範囲で最小の拡張にとどめる。

### 5.3 ロール別「何を見て、何を押すか」（1 画面内の表示出し分け）

全ロール同一 URL（`/dashboard`）で、**表示ブロックの有無と導線**だけをロールで出し分ける。

| ブロック | owner | manager | staff | reception | 見る内容・押す導線 |
|----------|-------|---------|-------|-----------|---------------------|
| **今日の予約タイムライン** | ○ | ○ | ○ | ○ | **見る**: 本日の予約一覧。次の予約が強調表示。<br>**押す**: 各予約 → 予約詳細／予約管理画面へ。 |
| **要対応アクション** | ○ | ○ | ○ | ○ | **見る**: 例外条件に該当する予約・事象のリスト。<br>**押す**: 各項目 → 該当予約の詳細／編集へ。 |
| **直近の変更・キャンセル** | ○ | ○ | ○ | ○ | **見る**: 直近のステータス変更・キャンセル一覧。<br>**押す**: 各項目 → 予約詳細または顧客詳細へ（確認・連絡の導線）。 |
| **設定への導線**（サイドナビ「設定」） | ○ | × | × | × | **見る**: ナビに「設定」が表示される。<br>**押す**: 設定画面へ。 |

- **owner / manager / staff / reception** の 4 ロールとも、上記 3 ブロック（今日の予約タイムライン・要対応アクション・直近の変更・キャンセル）は **すべて表示**する。違いは **設定メニューの有無のみ**（owner のみ「設定」を表示）。
- 「売上サマリー」「総顧客数」「リソース稼働率」「分析・グラフ」は **A フェーズでは必須としない**。実装する場合は owner/manager に限り表示してもよいが、**行動を促す 3 ブロックを最優先**で配置する。B フェーズで売上分析等を拡張する想定のため、A では控えめにする。

### 5.4 例外の条件（要対応アクション用）

要対応アクションに載せる「例外」は、**既存の予約データのみ**で Yes/No 判定できる条件に限定する。A 範囲内で列挙する。

以下を **例外条件の一覧** とする。各条件は「該当する場合に要対応リストに 1 件として表示する」ための判定に用いる。

| # | 条件名 | 判定内容（Yes のとき要対応に載せる） | データ元 |
|---|--------|----------------------------------------|----------|
| 1 | **開始まで N 時間なのに未確定** | 予約の `start_time` が現在時刻から N 時間以内であり、かつ `status` が pending（未確定）である。N は店舗設定または固定値（例: 24 時間）でよい。 | bookings |
| 2 | **本日予約が未確定のまま** | 予約日が本日で、`status` が pending である。 | bookings |
| 3 | **キャンセル期限超過の可能性** | 予約にキャンセル期限（または店舗のデフォルト期限）があり、現在時刻がそれを過ぎているのに `status` がまだ確定系（confirmed 等）である場合。「キャンセル期限を過ぎているので変更は不可」などの注意喚起として表示。※ 期限が DB や設定に無い場合はこの条件はスキップする。 | bookings / 店舗設定 |
| 4 | **重複予約の疑い** | 同一 `resource_id`（同一リソース）・同一日・時間帯が重なっている予約が 2 件以上存在する。既存の重複チェックロジックがあればそれに合わせる。 | bookings |
| 5 | **直近のキャンセル（未確認）** | 直近 X 日以内に `status` が cancelled に変更された予約のうち、スタッフが「確認済み」などとマークしていないもの。※ 「確認済み」フラグが無い場合は、単に「直近のキャンセル一覧」として表示し、確認導線のみ付与する。 | bookings |

- 上記は **表示設計上の条件** であり、**新規ビジネスロジックの追加** は最小限とする。既存の `bookings` の `status`・`start_time`・`resource_id`・日付等で判定できる範囲で実装する。
- 判定は **フロントで既存 API の取得結果をフィルタする** か、既存の一覧 API にパラメータがあればそれを使う。**新規 API は原則作らない**。必要なら既存の `GET /api/v1/bookings` のパラメータで取得範囲を絞り、フロントで上記条件に該当するものを「要対応」として表示する。

### 5.5 データ取得元（既存のみ）

- **新規 API は原則追加しない**。既存の API および既存テーブルのみを使用する。
- 想定する取得元:
  - **今日の予約タイムライン**: `GET /api/v1/bookings`（日付＝本日で取得）。次の予約の強調はフロントで現在時刻と比較して行う。
  - **要対応アクション**: 上記 5.4 の条件に基づき、`GET /api/v1/bookings` で取得したデータをフロントでフィルタする。または既存の一覧 API で取得可能な範囲で判定する。
  - **直近の変更・キャンセル**: `GET /api/v1/bookings` で直近分を取得（日付範囲・ステータス等、既存パラメータの範囲で）。キャンセル・ステータス変更は `status` や `updated_at` で判定する。
- 必要なら既存 API の **パラメータの拡張**（例: 日付範囲・status 指定）で対応し、新規エンドポイントは作らない方針とする。

### 5.6 将来拡張（B フェーズ）に退避するもの

以下は **B フェーズ（売上最大化・分析強化）** に属するため、A フェーズの本仕様では **必須としない**。実装しないか、将来拡張として明示する。

- 売上サマリー・売上分析・売上グラフ
- 総顧客数・今月の新規顧客数の「分析用」表示
- リソース稼働率の分析表示
- 回数券・コース券の管理・表示
- アップセル・クロスセル等の販促導線
- 業種別 KPI・業種別ダッシュボード
- 複数店舗・テナント横断のダッシュボード
- ダッシュボード専用の新規集計 API（A では既存 API の組み合わせで完結させる）

---

## 6. セキュリティ設計

### 6.1 store_id 強制スコープ

- すべての管理者向け API は **認証ユーザーの `store_id` でスコープ**する。
- TenantScope および各 Controller の `auth()->user()->store_id` を維持する。

### 6.2 他店舗データ参照不可

- 他店舗の予約・顧客・メニュー・リソースへのアクセスは **禁止**。既存の 403 返却を維持する。

### 6.3 ロール改ざん対策

- ロールは **常にサーバー側の `users.role`** に基づく。クライアントからロールを送信して変更することは認めない。`GET /api/v1/auth/user` の `role` および `permissions_summary` を正とする。

---

## 7. 将来拡張（B フェーズ）との切り分け

| 項目 | A フェーズ（本仕様 v1.1） | B フェーズ（将来） |
|------|----------------------------|---------------------|
| 認証 | トークン・単店舗・店舗管理者のみ | テナント管理者・複数店舗切り替え等 |
| ロール | 4 ロール・表示制御のみ | API 実行可否のロール制限・RBAC 拡張 |
| ダッシュボード | **行動を促す 3 ブロック**（今日の予約タイムライン・要対応アクション・直近の変更・キャンセル）。既存 API のみ。 | 売上分析・KPI・レポート・回数券・アップセル・新規集計 API |
| URL | `/admin/login`, `/admin/dashboard` のみ | ロール別 URL やテナント用画面の追加は検討 |
| 店舗 | 1 契約 = 1 店舗 | 複数店舗・tenant 管理 |

本仕様は **A フェーズの範囲のみ** を定義する。B フェーズの機能には一切触れない。

---

## 8. 実装時の自問（スコープ確認）

仕様に迷った場合は、以下を確認する。

- これは **予約完走に必要か？**  
- これは **B フェーズに属さないか？**  
- **URL や API・構造を増やしていないか？**

3 つとも Yes でない場合は、本仕様には含めない。

---

**以上、管理画面の認証・ロール・ダッシュボード構成の MVP（A フェーズ）仕様 v1.1 とする。ダッシュボードは「行動を促す」表示設計に寄せる。**
