# 管理画面 認証・ロール別ダッシュボード 要件 v1.0

**Version**: 1.0  
**Date**: 2025-02-11  
**Project**: tugical（ツギカル）  
**参照**: tugical_personas_and_users_v1.0.md, UserResource (permissions_summary)

> **※ 最新の要件定義は v1.1 です。**  
> 仕様書 v1.2.1 に合わせた要件は **admin_auth_and_role_dashboard_requirements_v1.1.md** を参照してください。

---

## 1. 概要

- **ログインページは共通**（全ロール同一画面）。
- **認証されていない場合は `/login` をデフォルト**とし、ログイン後に**権限（ロール）に応じて遷移先を変える**。

対象は**店舗管理者**（User + store_id + role）のみ。テナント管理者・システム管理者は将来拡張とする。

---

## 2. URL 設計

| 用途 | URL（管理画面 SPA 内） | 備考 |
|------|------------------------|------|
| ログイン画面（共通） | **`/login`** | 未認証時のデフォルト遷移先 |
| オーナー用ダッシュボード | `/dashboard` または `/dashboard/owner` | 全機能・分析・設定入口 |
| マネージャー用ダッシュボード | `/dashboard` または `/dashboard/manager` | 分析あり・設定なし |
| スタッフ／受付用ダッシュボード | `/dashboard` または `/dashboard/operation` | 予約・顧客中心、分析なし |

**ベースパス**: 管理画面 SPA は Laravel で `/admin` にマウントされているため、ブラウザ上の実際の URL は次のとおり。

- ログイン画面: **`/admin/login`**
- ダッシュボード: **`/admin/dashboard`**（ロール別表示は同一 URL で中身を出し分けてもよい）

要件上「デフォルトを `/login` に」とは、**SPA 内パス `/login`**（フル URL では `/admin/login`）を未認証時のデフォルトとする、と解釈する。

---

## 3. 認証フロー要件

### 3.1 未認証時

- 管理画面（`/admin` または `/admin/*`）にアクセスした場合、**認証されていなければ必ず `/login` にリダイレクト**する。
- 遷移元 URL は保持し、ログイン成功後に**その URL へ戻す**（保存できない場合は `/dashboard` へ）。
- すでに `/login` にいる場合はリダイレクトしない。

### 3.2 ログイン画面（共通）

- **全ロール共通**の 1 つのログイン画面を使う（メール + パスワード、店舗選択は既存のまま）。
- ログイン成功後は「3.3 ログイン後」に従い、**ロールに応じた遷移**を行う。

### 3.3 ログイン後の遷移（ロール別）

- **遷移先の優先順位**
  1. 認証前にアクセスしようとした URL（`from`）が存在し、かつ**そのロールでアクセス可能**なら、その URL へ。
  2. 上記以外は、**ロールに応じたデフォルトダッシュボード**へ。

- **ロール別デフォルト遷移先**

| role | デフォルト遷移先 | 説明 |
|------|------------------|------|
| owner | `/dashboard` | 全機能・分析・設定を含むダッシュボード |
| manager | `/dashboard` | 分析あり・設定管理なしのダッシュボード |
| staff | `/dashboard` | 予約・顧客中心の運用用ダッシュボード |
| reception | `/dashboard` | 受付用（予約・顧客中心）ダッシュボード |

※ 同一 URL `/dashboard` で、**表示内容だけロールで出し分ける**形でもよい（owner は分析カード表示、staff/reception は今日の予約中心など）。

### 3.4 認証済みで `/login` にアクセスした場合

- すでにログイン済みなら **`/dashboard` にリダイレクト**する（ログイン画面は表示しない）。

---

## 4. ロール別ダッシュボード表示要件

### 4.1 ロール定義（既存）

| role | 説明 | can_manage_users | can_manage_settings | can_view_analytics |
|------|------|------------------|---------------------|---------------------|
| owner | オーナー | ○ | ○ | ○ |
| manager | マネージャー | × | × | ○ |
| staff | スタッフ | × | × | × |
| reception | 受付 | × | × | × |

### 4.2 ダッシュボードの出し分け方針

- **URL**: 全ロールとも `/dashboard` でよい（ロール別 URL を増やさない）。
- **表示内容**: `user.role` および `user.permissions_summary` に基づき、**同一ページ内で表示ブロックを出し分ける**。

| 表示ブロック | owner | manager | staff | reception |
|--------------|-------|---------|-------|-----------|
| 今日の予約 | ○ | ○ | ○ | ○ |
| 売上サマリー | ○ | ○ | × | × |
| 総顧客数・今月の新規 | ○ | ○ | × | × |
| リソース稼働率 | ○ | ○ | × | × |
| 分析・グラフ | ○ | ○ | × | × |
| アクティビティタイムライン | ○ | ○ | ○ | ○ |
| 設定への導線 | ○ | × | × | × |

※ サイドナビの「設定」リンクも、`can_manage_settings` が true のときのみ表示する。

### 4.3 ナビゲーションの出し分け（既存方針との整合）

- ロールで**表示してよいメニュー**だけサイドバーに出す。
- 例: 「設定」は `can_manage_settings === true` のときのみ表示。
- 将来的に「ユーザー管理」を追加する場合は `can_manage_users` で制御。

---

## 5. 実装上の注意

- **認証状態の判定**: 既存の `authStore`（token / user の有無）および、必要に応じて `authApi.getCurrentUser()` の結果で行う。
- **リダイレクト**: React Router の `Navigate` または `navigate()` を使用。未認証時は `/login`、認証済みで `/login` に来た場合は `/dashboard`。
- **遷移元の保持**: `location.state?.from` または同等の方法で、ログイン後の戻り先を保持する。
- **ルートガード**: 認証が必要なルートは、認証済みでない場合に `/login` へリダイレクトするコンポーネントでラップする。

---

## 6. まとめ

| 項目 | 要件 |
|------|------|
| ログイン画面 | 共通 1 画面（全ロール同一） |
| 未認証時のデフォルト URL | **`/login`**（SPA 内。フル URL は `/admin/login`） |
| ログイン後の遷移 | 遷移元が許可されていればその URL、そうでなければ **ロールに応じた `/dashboard`** |
| ダッシュボードの違い | **同一 URL `/dashboard`** で、**ロールに応じて表示内容を出し分け** |
| 認証済みで `/login` アクセス | **`/dashboard` へリダイレクト** |

この要件に沿って、ルーターの組み込み・ルートガード・ログイン後リダイレクト・ダッシュボードの表示分岐を実装する。
