# tugical ペルソナ・ユーザー概念整理 v1.0

**Version**: 1.0  
**Date**: 2025-02-11  
**Project**: tugical（ツギカル）

---

## 概要

tugical では、**ペルソナごとに「ユーザー」の概念を分けて**設計・実装する。  
特に**テナントが複数店舗を持つ場合**を考え、**テナント管理者**（テナント単位）と**店舗管理者**（店舗単位）の 2 段階を設ける。

| ペルソナ           | 説明（一言）                 | 認証・入口           | データモデル・スコープ       |
| ------------------ | ---------------------------- | -------------------- | ---------------------------- |
| **システム管理者** | プラットフォーム運用者       | 将来: 専用管理画面   | テナント横断（現状は手動）   |
| **テナント管理者** | テナント単位で複数店舗を管理 | 管理画面 + Sanctum   | `tenant_id`（複数 store にアクセス可） |
| **店舗管理者**     | 1 店舗の予約・設定を操作     | 管理画面 + Sanctum   | `User` + `store_id`          |
| **利用者**         | 予約するお客様               | 当初は **LINE のみ** | `Customer` + `store_id`      |

---

## 1. システム管理者（System Administrator）

### 定義

- **誰**: tugical プラットフォーム全体を運用する側（運営会社・委託運用者）
- **責務**: テナント・店舗の作成・停止、プラン変更、障害対応、監視、問い合わせ対応

### ユーザー概念

- **スコープ**: テナント横断。特定の `tenant_id` / `store_id` に紐づかない。
- **認証**: 現状は仕様・運用で定義し、専用の管理画面・APIは将来実装とする。
- **データ**: 現時点では**運用・手動操作**で対応可能とする。
- **備考**: マルチテナントの「外側」にいる存在。TenantScope の対象外。

### 主な操作（想定）

- テナント（tenants）の作成・無効化
- 店舗（stores）の作成・無効化・プラン紐づけ
- システムログ・監視の確認
- サポート・問い合わせ対応

---

## 2. テナント管理者（Tenant Administrator）

### 定義

- **誰**: **1 つのテナント（事業者）に属し、そのテナント配下の複数店舗をまたいで管理する人**（本部・オーナー・チェーン責任者など）
- **責務**: 複数店舗の横断的な確認、店舗の追加・設定方針、テナント共通設定、レポート・集計

### ユーザー概念

- **スコープ**: **テナント（tenant_id）単位**。同一テナント内の複数 store にアクセス可能（店舗切り替えまたは一括表示）。
- **認証**: 管理画面（`/admin`）+ Laravel Sanctum。ログイン後、店舗選択で対象 store を切り替える想定。
- **データ**: 将来実装として、`User` に `tenant_id` を持たせ `store_id` を nullable とする、または別のテナント管理者用モデルを検討。現状は「1 ユーザー = 1 店舗」のため、複数店舗の場合は**店舗ごとにアカウントを持つ**運用で対応可能。
- **備考**: プロプラン・エンタープライズなど「複数店舗」プランで重要になる層。実装時は TenantScope の拡張（tenant_id スコープまたは store_id の複数許可）が必要。

### 主な操作（想定）

- テナント配下の全店舗一覧・ダッシュボード
- 店舗の追加・基本設定（店舗管理者の権限委譲含む）
- テナント共通の通知テンプレ・方針設定
- 複数店舗にまたがる予約・売上レポート

---

## 3. 店舗管理者（Store Administrator / Store Staff）

### 定義

- **誰**: **1 つの店舗（store）に所属し、その店舗の予約・設定・マスタを操作する人**（店長、スタッフ、受付など）
- **責務**: 予約の確認・作成・変更・キャンセル、メニュー・リソース・顧客マスタの管理、店舗設定、通知設定

### ユーザー概念

- **スコープ**: **必ず 1 つの店舗（store_id）に所属**。マルチテナント分離の中心。他店舗のデータにはアクセスしない。
- **認証**: Laravel Sanctum（メール + パスワード）。管理画面（`/admin`）にログイン。
- **データ**:
  - **User** モデル: `store_id`, `role`（owner / manager / staff / reception）
  - 必要に応じて **StaffAccount** と連携（スタッフアカウント・ロールの細分化）
- **権限**: 役割（role）に応じた権限制御。同一店舗内のみアクセス可能（TenantScope）。

### 主な操作

- 予約の一覧・作成・編集・キャンセル・ステータス変更
- 空き時間確認・仮押さえ（電話予約ワークフロー含む）
- 顧客マスタの閲覧・登録・編集
- メニュー・リソースの設定
- 店舗設定（営業時間、時間スロット、通知、LINE 連携など）
- 通知テンプレート・送信履歴の確認

### 既存実装との対応

- API: `/api/v1/auth/login`, `/api/v1/auth/user` + Bearer Token
- 全管理者向け API は `auth:sanctum` と TenantScope により **そのユーザーの store_id で自動スコープ**
- 現状の「テナント管理者」として記載していた実装は、すべて**店舗管理者**に該当

---

## 4. 利用者（End User / Customer）

### 定義

- **誰**: 店舗に**予約をする「お客様」**
- **責務**: 空き時間の確認、予約の申し込み・キャンセル（および将来のマイページ確認など）

### ユーザー概念

- **スコープ**: **店舗（store_id）ごとに顧客として登録**。1 人の LINE ユーザーが複数店舗で別々の「顧客」になり得る。
- **認証**:
  - **当初は LINE のみ**: LIFF 上で LINE ログイン → 店舗ごとに顧客の get-or-create → 予約。
  - 将来: Web 会員ログイン・電話番号のみなど拡張可能。
- **データ**:
  - **Customer** モデル: `store_id`, `line_user_id`（LINE 連携時）, `name`, `phone`, `email` など
  - 予約（bookings）は `customer_id` で紐づく

### 主な操作（LINE 経由）

- LIFF で店舗のメニュー閲覧
- 日付・メニュー・リソースを選んで空き時間確認
- 仮押さえ → 予約確定
- 予約内容の確認・キャンセル（仕様・画面次第）

### 既存実装との対応

- API: `/api/v1/liff/*`（認証は LIFF 前提。store_id はクエリ/body で渡し、マルチテナント分離）
- 顧客の同定: `store_id` + `line_user_id` または `customer_id`（get-or-create で取得した ID）

---

## まとめ図

```
┌─────────────────────────────────────────────────────────────────┐
│  tugical プラットフォーム                                         │
├─────────────────────────────────────────────────────────────────┤
│  システム管理者（将来）                                           │
│  └ テナント・店舗の作成/停止、プラン、監視（テナント横断）          │
├─────────────────────────────────────────────────────────────────┤
│  テナント管理者（将来・複数店舗対応時）                             │
│  └ tenant_id スコープ／複数 store にアクセス・店舗切り替え         │
├─────────────────────────────────────────────────────────────────┤
│  店舗管理者（現在実装済み）                                         │
│  └ User (store_id, role) → /admin → Sanctum                       │
│  └ 予約・顧客・メニュー・リソース・店舗設定の操作                   │
├─────────────────────────────────────────────────────────────────┤
│  利用者（当初は LINE のみ）                                        │
│  └ Customer (store_id, line_user_id) → LIFF → 予約申し込み        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 階層の対応関係

| 階層             | スコープ     | 複数店舗           | 現状実装 |
| ---------------- | ------------ | ------------------ | -------- |
| システム管理者   | プラットフォーム | —                  | 運用対応 |
| テナント管理者   | テナント     | 複数店舗をまたぐ   | 将来     |
| 店舗管理者       | 店舗         | 1 店舗のみ        | ✅ User + store_id |
| 利用者           | 店舗（顧客） | 店舗ごとに顧客     | ✅ Customer |

---

## 仕様書・実装との対応

| ドキュメント               | 参照すべきペルソナ                         |
| -------------------------- | ------------------------------------------ |
| 要件定義書・API 仕様書     | 店舗管理者 / 利用者（テナント管理者は将来） |
| データベース設計書         | User（店舗管理者）, Customer（利用者）, tenants/stores |
| UI/UX 設計書               | 管理画面＝テナント管理者・店舗管理者、LIFF＝利用者 |
| マルチテナント・TenantScope | 店舗管理者は store_id でスコープ、テナント管理者は tenant_id でスコープ（将来） |

---

**以上、ペルソナごとのユーザー概念の整理とする。実装・仕様の判断時は本ドキュメントを参照する。**
