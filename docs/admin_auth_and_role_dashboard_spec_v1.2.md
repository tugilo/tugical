# 管理画面 認証・ロール・ダッシュボード 仕様書 v1.2（MVP Aフェーズ）

**Version**: 1.2  
**作成日**: 2026-02-11 16:44  
**更新日**: 2026-02-11 16:44  
**Project**: tugical（ツギカル）  
**Phase**: MVP A（予約を迷わず完走できる）

---

## v1.1 からの変更点

- **相棒思想**を目的・設計方針に明記した（ダッシュボードは「管理画面」ではなく「店舗運営の相棒」として振る舞う）。
- **ひとことメッセージ**仕様を新規追加。`/admin/dashboard` 最上段に 1 文（最大 2 行）のメッセージを表示する。
- メッセージの**入力データ**は既存予約データのみ（今日の予約件数・要対応件数・次の予約時刻・当日変更・キャンセル有無）。新規 API・新規テーブルは不要。
- **メッセージ決定ルール**を優先順位付き（ルール A → B → C）で定義。最初に一致したものを採用。
- **ロール別出し分け**（owner/manager そのまま、staff は自分関連優先・難しければ全体、reception は要対応寄せ）。取得できない場合は全体文言にフォールバック。
- **文言ガイド**を固定（句読点少なめ・1 文・否定・強い命令を避ける・例外時も「確認しましょう」程度）。
- **UI 状態**を定義（要対応 > 0 は注意状態、要対応 = 0 は正常状態。色は UI に委ねる）。
- 既存の必須 3 ブロック（要対応アクション・今日の予約タイムライン・直近の変更・キャンセル）は維持。

---

## 1. 目的

本仕様は、**運用安全性を高める整理**であり、機能追加ではない。

- 認証・ロール・ダッシュボードの扱いを MVP 範囲で明文化する。
- ダッシュボードの目的を **「見るだけ」ではなく「行動を促す」** に据え、既存予約データの**表示設計**で「次に何をすべきか」が分かる構成とする。
- **相棒思想**: 本ダッシュボードは「管理画面」ではなく **「店舗運営の相棒」** として振る舞う。表示は簡潔に（1 文）。エラー/警告ではなく“助言”の言い回し。例外は強調するが説教しない。0 件のときはポジティブに。
- 単店舗前提（1契約=1店舗）を守る。
- 将来の B フェーズ（売上最大化・複数店舗等）に拡張できる構造を壊さない。
- 実装可能なレベルまで具体化する。

**正とするドキュメント**:  
tugical_project_overview.md / CONCEPT_SPEC_FIT_GAP.md / tugical_requirements_specification_v1.1.md / admin_auth_and_role_dashboard_requirements_v1.0.md / admin_auth_and_role_dashboard_spec_v1.1.md

---

## 2. 適用範囲（MVP 内）

| 対象 | 範囲 |
|------|------|
| 認証 | 店舗管理者（User + store_id）のログイン・ログアウト・トークン認証のみ |
| ロール | owner / manager / staff / reception の 4 種。表示制御のみ。ルーティング分岐は行わない。 |
| ダッシュボード | **相棒としての表示設計**。ひとことメッセージ + 必須ブロック 3 種 + ロール別出し分け。既存テーブル・既存 API のみ。新規 API は原則作らない。 |
| URL | `/admin/login` と `/admin/dashboard` のみ。これ以外の URL は増やさない。 |

**本仕様で行わないこと**:  
新規テーブル追加、新規 API 追加、売上/分析/KPI の導入、複数店舗/tenant 管理、通知（LINE）の新規送信、文章生成 AI の導入、業種分岐、URL の追加。

---

## 3. 認証仕様

### 3.1 認証方式

- **トークン認証**（Laravel Sanctum API Token）を使用する。
- セッション（Cookie）認証は使用しない。管理画面 SPA は Bearer トークンで API にアクセスする。

### 3.2 ログイン処理フロー

1. ユーザーが `/admin/login`（SPA 内パスは `/login`）で、メール・パスワード・**store_id**（店舗選択）を入力する。
2. フロントは `POST /api/v1/auth/login` に上記を送信する。
3. バックエンドは `users` テーブルで `email` + `store_id` でユーザーを特定し、パスワードを検証する。
4. 検証成功時: 既存トークンを削除し、新規 Sanctum トークンを発行。`UserResource` でユーザー情報（id, name, email, role, store_id, permissions_summary 等）と店舗情報を返却する。
5. フロントはトークン・ユーザー・店舗を保持（例: authStore + persist）し、`/dashboard` へ遷移する。
6. 検証失敗時: 401 または 403 を返し、フロントはログイン画面に留まる。

※ ログイン API の詳細は既存の AuthController および tugical_api_specification に従う。

### 3.3 ログアウト処理

1. フロントは `POST /api/v1/auth/logout` を呼び出す（Bearer トークン付き）。
2. バックエンドは当該ユーザーの Sanctum トークンを削除する。
3. フロントはローカル状態（authStore）をクリアし、`/login` へリダイレクトする。

### 3.4 トークン有効期限

- **Sanctum のデフォルト**: `config/sanctum.php` の `expiration` が `null` の場合はトークンは無期限。
- MVP では **有効期限は変更しない**。

### 3.5 store_id のスコープ制御方法

- **単店舗前提**: 1 契約 = 1 店舗。
- ログイン時に指定した **store_id** と、`users.store_id` が一致するユーザーのみログイン可能。
- 認証済みリクエストでは、**すべての管理者 API で `auth()->user()->store_id` をスコープ**に用いる。既存の TenantScope および各 Controller の `auth()->user()->store_id` による絞り込みを維持する。
- 他店舗のデータを参照・更新するリクエストは許可しない。

---

## 4. ロール仕様（MVP 範囲）

### 4.1 対象ロール

| role | 説明 | 判定元 |
|------|------|--------|
| owner | オーナー | `users.role` |
| manager | マネージャー | `users.role` |
| staff | スタッフ | `users.role` |
| reception | 受付 | `users.role` |

- **ロール判定方法**: 必ず **サーバーから返却された `user.role`**（および `user.permissions_summary`）を用いる。
- **権限分岐**: **表示制御のみ**。ルーティング分岐は行わない。全ロールとも `/login` と `/dashboard` のみを使用する。

### 4.2 permissions_summary の参照

- ロールに応じた表示制御には、ログイン時および `GET /api/v1/auth/user` で返却される **`permissions_summary`** を用いる。
- 既存の `UserResource::getPermissionsSummary()` に準拠する（can_manage_users, can_manage_settings, can_view_analytics 等）。MVP ではこの構造を変更しない。

### 4.3 編集可能な範囲（MVP）

- **API 側**: 既存どおり、すべての管理者 API は `auth:sanctum` と `store_id` スコープのみで制御。ロールによる API レベルの編集制限は **追加しない**。
- **画面側**: 「設定」メニューは `can_manage_settings === true` のときのみ表示する。

---

## 5. ダッシュボード仕様（行動を促す設計・相棒としての振る舞い）

### 5.1 ダッシュボードの目的と設計方針

- **目的**: 「見るだけのダッシュボード」ではなく **「行動を促すダッシュボード」** とする。開いた人が **次に何をすべきか** が分かり、**どこを押せばそのアクションに進めるか** が明確であること。
- **相棒思想**: 本ダッシュボードは「管理画面」ではなく **「店舗運営の相棒」** として振る舞う。
  - 表示は簡潔に（1 文）。
  - エラー/警告ではなく“助言”の言い回し。
  - 例外は強調するが、説教しない。
  - 0 件のときはポジティブに。
- 機能追加は行わない。**既存予約データの表示設計**（並び順・強調・ラベル・導線・ひとことメッセージ）で行動を促す。

### 5.2 ひとことメッセージ仕様

ダッシュボード最上段に、**1 文（最大 2 行）** の「ひとことメッセージ」を表示する。既存の取得データのみで生成し、新規 API・新規テーブル・文章生成 AI は使用しない。**固定文 + 条件分岐のみ**で実現する。

#### 5.2.1 表示位置

- **位置**: `/admin/dashboard` の **最上段**（要対応アクションブロックのさらに上）。
- **長さ**: 1 行を原則。最大でも 2 行まで。長文化しない。

#### 5.2.2 入力データ（既存予約データのみ）

メッセージの決定に用いるデータは、**既存 API で取得した予約データ**から算出する。以下を利用する。

| データ | 説明 | 備考 |
|--------|------|------|
| 今日の予約件数 | 本日の予約の件数 | 必須。取れない場合は 0 として扱う。 |
| 要対応アクション件数 | 5.4 の例外条件に該当する件数 | 必須。取れない場合は 0 として扱う。 |
| 次の予約時刻 | 現在時刻以降で直近の予約の開始時刻 | 存在すれば使用。取れない場合は省略。 |
| 当日変更・キャンセルの有無 | 本日中に変更またはキャンセルされた予約の有無 | 存在すれば使用。取れない場合は省略。 |

※ **データが取れない場合**は「今日の予約件数」と「要対応件数」のみでメッセージを成立させる（フォールバック文言を用意する）。

#### 5.2.3 メッセージ決定ルール（優先順位付き）

**上から順に判定し、最初に一致したルールのメッセージを採用する。**

- **ルール A: 要対応が 1 件以上**
  - 例: 「今日は {needs_count} 件、確認が必要です」
  - 例: 「{next_time} の予約、念のため確認しておきましょう」
  - wording は“相棒”の口調。断定や命令を避ける。

- **ルール B: 今日の予約が 0 件**
  - 例: 「今日は予約がありません。落ち着いて準備できそうです」
  - 例: 「今日はゆっくりめの日です。やり残しを片づけるチャンスかもしれません」

- **ルール C: 要対応 0 かつ 今日の予約が 1 件以上**
  - 例: 「今日は {today_count} 件の予約です。スムーズに進みそうです」
  - 例: 「次の予約は {next_time} です。いい一日にしましょう」

※ `{needs_count}` / `{today_count}` / `{next_time}` は取得した数値・時刻で置換する。次の予約時刻が取れない場合は、ルール C では「今日は {today_count} 件の予約です」など時刻を含まない文言を選ぶ。

#### 5.2.4 ロール別出し分け（表示制御のみ）

- **owner / manager**: 上記ルール A〜C をそのまま使用する。
- **staff**: 自分に関係する予約（可能なら）を優先した文言を選んでもよい。MVP で「自分担当」の切り分けが難しければ、**全体の文言にフォールバック**する。無理しない。
- **reception**: 要対応（未確定・変更）に寄せた文言を優先する。例: 要対応 > 0 のとき「{needs_count} 件、確認しておくと安心です」など。取得できない場合は全体文言にフォールバックする。

※ いずれも **取得できない場合は「全体」の文言にフォールバック**する。

#### 5.2.5 文言ガイド（仕様として固定）

- 句読点は少なめ。
- 1 文で完結させる。
- 否定語・強い命令を避ける（例:「必ず」「至急」は使わない）。
- 例外時も「確認しましょう」「確認しておきましょう」程度に留める。説教しない。

#### 5.2.6 UI 状態

- **要対応 > 0 のとき**: 注意状態とする。色・アイコン等は仕様では定めず、**UI 側に委ねる**。
- **要対応 = 0 のとき**: 正常状態とする。

---

## 5.3 必須ブロック（3 種）

以下をダッシュボードの必須ブロックとして定義する。**ひとことメッセージの直下**に配置する。いずれも既存の `bookings`（および必要に応じて `customers`）の取得結果から表示する。

| # | ブロック名 | 役割 | 表示内容の要点 |
|---|------------|------|----------------|
| 1 | **今日の予約タイムライン** | 「今・次」が分かる | 本日の予約を時間軸で表示。**次の予約**（現在時刻から見て直近の未完了予約）を視覚的に強調する。各予約から「予約詳細・編集」への導線（クリックで予約管理へ）を用意する。 |
| 2 | **要対応アクション** | 例外・アラートで漏れを防ぐ | 「例外の条件」を満たした予約・事象をリスト表示。1 件ごとに「確認する」「対応する」などの導線を付与。0 件のときは「要対応はありません」と表示してよい。 |
| 3 | **直近の変更・キャンセル** | 確認導線 | 直近でステータス変更・キャンセルされた予約をリスト表示。内容確認・必要なら顧客連絡などの導線（予約詳細・顧客詳細へのリンク）を付与する。 |

- データ取得は **既存 API のみ**（例: `GET /api/v1/bookings` に日付・ステータス等のパラメータで取得）。新規 API は原則作らない。

### 5.4 ロール別「何を見て、何を押すか」（1 画面内の表示出し分け）

全ロール同一 URL（`/dashboard`）で、**表示ブロックの有無と導線**だけをロールで出し分ける。

| ブロック | owner | manager | staff | reception | 見る内容・押す導線 |
|----------|-------|---------|-------|-----------|---------------------|
| **ひとことメッセージ** | ○ | ○ | ○ | ○ | **見る**: 最上段の 1 文。ロールに応じた文言。<br>**押す**: なし（表示のみ）。 |
| **今日の予約タイムライン** | ○ | ○ | ○ | ○ | **見る**: 本日の予約一覧。次の予約が強調表示。<br>**押す**: 各予約 → 予約詳細／予約管理画面へ。 |
| **要対応アクション** | ○ | ○ | ○ | ○ | **見る**: 例外条件に該当する予約・事象のリスト。<br>**押す**: 各項目 → 該当予約の詳細／編集へ。 |
| **直近の変更・キャンセル** | ○ | ○ | ○ | ○ | **見る**: 直近のステータス変更・キャンセル一覧。<br>**押す**: 各項目 → 予約詳細または顧客詳細へ（確認・連絡の導線）。 |
| **設定への導線**（サイドナビ「設定」） | ○ | × | × | × | **見る**: ナビに「設定」が表示される。<br>**押す**: 設定画面へ。 |

- **owner / manager / staff / reception** の 4 ロールとも、**ひとことメッセージ** と上記 3 ブロックは **すべて表示**する。違いは **設定メニューの有無**（owner のみ「設定」を表示）および、ひとことメッセージの **文言の優先**（staff・reception は上述の出し分け。難しければ全体文言）。

### 5.5 例外の条件（要対応アクション用）

要対応アクションに載せる「例外」は、**既存の予約データのみ**で Yes/No 判定できる条件に限定する。

| # | 条件名 | 判定内容（Yes のとき要対応に載せる） | データ元 |
|---|--------|----------------------------------------|----------|
| 1 | **開始まで N 時間なのに未確定** | 予約の `start_time` が現在時刻から N 時間以内であり、かつ `status` が pending（未確定）である。N は店舗設定または固定値（例: 24 時間）でよい。 | bookings |
| 2 | **本日予約が未確定のまま** | 予約日が本日で、`status` が pending である。 | bookings |
| 3 | **キャンセル期限超過の可能性** | 予約にキャンセル期限（または店舗のデフォルト期限）があり、現在時刻がそれを過ぎているのに `status` がまだ確定系（confirmed 等）である場合。※ 期限が DB や設定に無い場合はスキップ。 | bookings / 店舗設定 |
| 4 | **重複予約の疑い** | 同一 `resource_id`・同一日・時間帯が重なっている予約が 2 件以上存在する。 | bookings |
| 5 | **直近のキャンセル（未確認）** | 直近 X 日以内に `status` が cancelled に変更された予約。※ 「確認済み」フラグが無い場合は、直近のキャンセル一覧として表示し、確認導線のみ付与。 | bookings |

- 判定は **フロントで既存 API の取得結果をフィルタ**する。**新規 API は原則作らない**。

### 5.6 データ取得元（既存のみ）

- **新規 API は原則追加しない**。既存の API および既存テーブルのみを使用する。
- **ひとことメッセージ**: 今日の予約件数・要対応件数・次の予約時刻・当日変更・キャンセル有無は、いずれも **既存の `GET /api/v1/bookings` 等で取得したデータをフロントで集計**して算出する。
- **今日の予約タイムライン**: `GET /api/v1/bookings`（日付＝本日）。次の予約の強調はフロントで現在時刻と比較。
- **要対応アクション**: 5.5 の条件に基づき、取得した bookings をフロントでフィルタ。
- **直近の変更・キャンセル**: `GET /api/v1/bookings` で直近分を取得（既存パラメータの範囲で）。`status` や `updated_at` で判定。

### 5.7 将来拡張（B フェーズ）に退避するもの

以下は **B フェーズ** に属するため、A フェーズでは **必須としない**。実装しないか、将来拡張として明示する。

- 売上サマリー・売上分析・売上グラフ
- 総顧客数・今月の新規顧客数の「分析用」表示
- リソース稼働率の分析表示
- 回数券・コース券の管理・表示
- アップセル・クロスセル等の販促導線
- 業種別 KPI・業種別ダッシュボード
- 複数店舗・テナント横断のダッシュボード
- ダッシュボード専用の新規集計 API
- 文章生成 AI によるメッセージ生成
- 通知（LINE）の新規送信トリガーとしてのダッシュボード連携

---

## 6. セキュリティ設計

### 6.1 store_id 強制スコープ

- すべての管理者向け API は **認証ユーザーの `store_id` でスコープ**する。
- TenantScope および各 Controller の `auth()->user()->store_id` を維持する。

### 6.2 他店舗データ参照不可

- 他店舗の予約・顧客・メニュー・リソースへのアクセスは **禁止**。既存の 403 返却を維持する。

### 6.3 ロール改ざん対策

- ロールは **常にサーバー側の `users.role`** に基づく。クライアントからロールを送信して変更することは認めない。`GET /api/v1/auth/user` の `role` および `permissions_summary` を正とする。

---

## 7. 将来拡張（B フェーズ）との切り分け

| 項目 | A フェーズ（本仕様 v1.2） | B フェーズ（将来） |
|------|----------------------------|---------------------|
| 認証 | トークン・単店舗・店舗管理者のみ | テナント管理者・複数店舗切り替え等 |
| ロール | 4 ロール・表示制御のみ | API 実行可否のロール制限・RBAC 拡張 |
| ダッシュボード | **相棒としての表示**。ひとことメッセージ + **行動を促す 3 ブロック**。既存 API のみ。固定文 + 条件分岐のみ。 | 売上分析・KPI・レポート・回数券・アップセル・AI 文言・新規集計 API |
| URL | `/admin/login`, `/admin/dashboard` のみ | ロール別 URL やテナント用画面の追加は検討 |
| 店舗 | 1 契約 = 1 店舗 | 複数店舗・tenant 管理 |

本仕様は **A フェーズの範囲のみ** を定義する。B フェーズの機能には一切触れない。

---

## 8. 実装時の自問（スコープ確認）

仕様に迷った場合は、以下を確認する。

- これは **予約完走に必要か？**  
- これは **B フェーズに属さないか？**  
- **URL や API・テーブル・構造を増やしていないか？**

3 つとも Yes でない場合は、本仕様には含めない。

---

**以上、管理画面の認証・ロール・ダッシュボード構成の MVP（A フェーズ）仕様 v1.2 とする。ダッシュボードは「店舗運営の相棒」として振る舞い、朝一番に開く理由を強める。**
