# 管理画面 認証・ロール別ダッシュボード 要件 v1.1

**Version**: 1.1  
**作成日**: 2026-02-11 16:53  
**更新日**: 2026-02-11 16:53  
**Project**: tugical（ツギカル）  
**Phase**: MVP A（予約を迷わず完走できる）

**参照**:  
tugical_personas_and_users_v1.0.md, UserResource (permissions_summary), **admin_auth_and_role_dashboard_spec_v1.2.1.md**（正とする仕様書）

---

## 1. 概要

- **ログインページは共通**（全ロール同一画面）。
- **認証されていない場合は `/login` をデフォルト**とし、ログイン後に **`/dashboard`** へ遷移する（全ロール同一 URL。表示内容のみロールで出し分ける）。
- 対象は**店舗管理者**（User + store_id + role）のみ。テナント管理者・システム管理者は将来拡張とする。
- ダッシュボードは **「管理画面」ではなく「店舗運営の相棒」** として振る舞う。**心理設計（相棒感の深掘り）は後回し可能**とし、MVP では固定文 + 条件分岐のみで完結する。

---

## 2. URL 設計

| 用途 | URL（管理画面 SPA 内） | 備考 |
|------|------------------------|------|
| ログイン画面（共通） | **`/login`** | 未認証時のデフォルト遷移先 |
| ダッシュボード | **`/dashboard`** | 全ロール共通。ロール別 URL は増やさない。 |

**ブラウザ上の URL**（Laravel で `/admin` にマウント）:

- ログイン画面: **`/admin/login`**
- ダッシュボード: **`/admin/dashboard`**

※ 仕様書と合わせ、**URL はこの 2 つのみ**とする。

---

## 3. 認証フロー要件

### 3.1 未認証時

- 管理画面（`/admin` または `/admin/*`）にアクセスした場合、**認証されていなければ必ず `/login` にリダイレクト**する。
- 遷移元 URL は保持し、ログイン成功後に**その URL へ戻す**（保存できない場合は `/dashboard` へ）。
- すでに `/login` にいる場合はリダイレクトしない。

### 3.2 ログイン画面（共通）

- **全ロール共通**の 1 つのログイン画面を使う（メール + パスワード、店舗選択は既存のまま）。
- ログイン成功後は **`/dashboard`** へ遷移する（全ロール同一。遷移元が許可されていればその URL へ戻す）。

### 3.3 ログイン後の遷移

- **遷移先の優先順位**
  1. 認証前にアクセスしようとした URL（`from`）が存在し、かつ**そのロールでアクセス可能**なら、その URL へ。
  2. 上記以外は **`/dashboard`** へ（ロール別 URL は使わない）。

### 3.4 認証済みで `/login` にアクセスした場合

- すでにログイン済みなら **`/dashboard` にリダイレクト**する（ログイン画面は表示しない）。

---

## 4. ダッシュボード要件（行動を促す・相棒としての振る舞い）

### 4.1 目的とスコープ

- **目的**: 「見るだけ」ではなく **「行動を促す」** ダッシュボード。開いた人が次に何をすべきか分かり、どこを押せばそのアクションに進めるか明確であること。
- **相棒思想**: 表示は簡潔に（1 文）。エラー/警告ではなく“助言”の言い回し。例外は強調するが説教しない。0 件のときはポジティブに。
- **MVP の範囲**: **固定文 + 条件分岐のみ**。新規 API・新規テーブル・学習・パーソナライズ・文章生成 AI は使わない。詳細は仕様書 v1.2.1 の「MVP固定仕様（ここまで）」に従う。

### 4.2 必須構成（4 要素）

ダッシュボードは以下で構成する。**ひとことメッセージ**を最上段に置き、その直下に **必須 3 ブロック**を配置する。

| # | 要素 | 役割 | 全ロール |
|---|------|------|----------|
| 0 | **ひとことメッセージ** | 最上段の 1 文（最大 2 行）。既存予約データのみで固定文 + 条件分岐で表示。 | ○ |
| 1 | **今日の予約タイムライン** | 本日の予約を時間軸で表示。次の予約を強調。各予約から予約詳細・編集へ導線。 | ○ |
| 2 | **要対応アクション** | 例外条件に該当する予約・事象のリスト。確認・対応への導線。0 件のときは「要対応はありません」等。 | ○ |
| 3 | **直近の変更・キャンセル** | 直近のステータス変更・キャンセル一覧。予約詳細・顧客詳細への確認導線。 | ○ |

- **設定への導線**（サイドナビ「設定」）は **owner のみ**表示。`can_manage_settings === true` のときのみ。

### 4.3 ひとことメッセージ要件

- **表示位置**: `/admin/dashboard` の**最上段**（要対応アクションブロックのさらに上）。1 行原則、最大 2 行。
- **入力データ**: 既存 API で取得した予約データのみ（今日の予約件数・要対応件数・次の予約時刻・当日変更・キャンセル有無）。取れない場合は予約件数と要対応件数のみで成立させる。
- **メッセージ決定ルール**: **上から順に**次の優先順位で判定し、**最初に一致したルール**のメッセージを採用する。
  - **ルール A**: 要対応が 1 件以上 → 例「今日は {needs_count} 件、確認が必要です」「{next_time} の予約、念のため確認しておきましょう」
  - **ルール B**: 今日の予約が 0 件 → 例「今日は予約がありません。落ち着いて準備できそうです」
  - **ルール C**: 要対応 0 かつ 今日の予約が 1 件以上 → 例「今日は {today_count} 件の予約です。スムーズに進みそうです」「次の予約は {next_time} です。いい一日にしましょう」
- **ロール別**: owner/manager は上記ルールそのまま。staff は自分関連を優先できればするが、難しければ全体文言にフォールバック。reception は要対応に寄せた文言を優先。取得できない場合は全体文言にフォールバック。
- **文言**: 句読点少なめ・1 文・否定・強い命令を避ける。例外時も「確認しましょう」程度に留める。
- **UI 状態**: 要対応 > 0 のときは注意状態、要対応 = 0 のときは正常状態。色・アイコンは UI に委ねる。

### 4.4 ロール別表示（出し分け方針）

- **URL**: 全ロールとも **`/dashboard`** のみ。ルーティング分岐は行わない。
- **表示内容**: `user.role` および `user.permissions_summary` に基づき、**同一ページ内で表示ブロックの有無と文言のみ出し分ける**。

| 表示要素 | owner | manager | staff | reception |
|----------|-------|---------|-------|-----------|
| ひとことメッセージ | ○ | ○ | ○ | ○ |
| 今日の予約タイムライン | ○ | ○ | ○ | ○ |
| 要対応アクション | ○ | ○ | ○ | ○ |
| 直近の変更・キャンセル | ○ | ○ | ○ | ○ |
| 設定への導線（サイドナビ） | ○ | × | × | × |

- 違いは **設定メニューの有無**（owner のみ）と、**ひとことメッセージの文言優先**（staff・reception は仕様書 5.2.4 に従う。難しければ全体文言）。

### 4.5 ロール定義（既存）

| role | 説明 | can_manage_settings | 備考 |
|------|------|---------------------|------|
| owner | オーナー | ○ | 設定メニュー表示。ひとことメッセージはルール A〜C そのまま。 |
| manager | マネージャー | × | ひとことメッセージはルール A〜C そのまま。 |
| staff | スタッフ | × | 自分関連予約を優先した文言が可能なら使用。難しければ全体文言。 |
| reception | 受付 | × | 要対応に寄せた文言を優先。取得できない場合は全体文言。 |

※ can_manage_users, can_view_analytics 等は既存の permissions_summary に準拠。MVP ではダッシュボードの表示制御は上記の範囲のみ。

### 4.6 MVP でやらないこと（要件として固定）

- 新規 API 追加（ダッシュボード専用エンドポイントは作らない）
- 新規テーブル追加（メッセージ履歴・ユーザー反応・パーソナライズ用など）
- 売上サマリー・分析・KPI・リソース稼働率の表示（B フェーズに退避）
- 学習・パーソナライズ（ユーザーごと・時間帯ごとの動的チューニング）
- 心理設計の深掘り（トーン設計・文脈別言い回しの体系化・A/B テスト等は将来拡張）
- 文章生成 AI の導入
- ロール別 URL（`/dashboard/owner` 等）の追加

---

## 5. 実装上の注意

- **認証状態の判定**: 既存の `authStore`（token / user の有無）および、必要に応じて `authApi.getCurrentUser()` の結果で行う。
- **リダイレクト**: React Router の `Navigate` または `navigate()` を使用。未認証時は `/login`、認証済みで `/login` に来た場合は `/dashboard`。
- **遷移元の保持**: `location.state?.from` または同等の方法で、ログイン後の戻り先を保持する。
- **ルートガード**: 認証が必要なルートは、認証済みでない場合に `/login` へリダイレクトするコンポーネントでラップする。
- **データ取得**: ひとことメッセージ・今日の予約・要対応・直近変更はいずれも **既存の `GET /api/v1/bookings` 等**で取得したデータをフロントで集計・フィルタする。新規 API は作らない。

---

## 6. まとめ

| 項目 | 要件 |
|------|------|
| ログイン画面 | 共通 1 画面（全ロール同一） |
| 未認証時のデフォルト URL | **`/login`**（SPA 内。フル URL は `/admin/login`） |
| ログイン後の遷移 | 遷移元が許可されていればその URL、そうでなければ **`/dashboard`** |
| ダッシュボード URL | **`/admin/dashboard`** のみ。ロール別 URL は使わない。 |
| ダッシュボード構成 | **ひとことメッセージ**（最上段）+ **今日の予約タイムライン** + **要対応アクション** + **直近の変更・キャンセル**。固定文 + 条件分岐のみ。 |
| ロール別の違い | 設定メニューの有無（owner のみ）+ ひとことメッセージの文言優先（staff/reception）。表示制御のみ。 |
| 認証済みで `/login` アクセス | **`/dashboard` へリダイレクト** |
| 正とする仕様書 | **admin_auth_and_role_dashboard_spec_v1.2.1.md** |

実装時は本要件に加え、**仕様書 v1.2.1**（例外条件・データ取得元・文言ガイド・MVP固定仕様・将来拡張スロット）に従う。
